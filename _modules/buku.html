<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>buku &mdash; buku  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> buku
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#table-of-contents">Table of Contents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#features">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#shell-completion">Shell completion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#usage">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#quickstart">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#examples">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#automation">Automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#collaborators">Collaborators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#contributions">Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#related-projects">Related projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#videos">Videos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#in-the-press">In the Press</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Wiki</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Customize-colors.html">Windows support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Installation-on-Termux.html">Install Buku on Termux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html">General</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#tags">Tags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#update">Update</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#delete">Delete</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#search">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#import">Import</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#encryption">Encryption</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#editor">Editor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#proxy">Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Operational-notes.html#alternative-db-file">Alternative DB file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/PR-guidelines.html">PR comment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/PR-guidelines.html#program-help">Program help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/PR-guidelines.html#coding-guidelines">Coding guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/System-integration.html">ToC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/System-integration.html#sync-bookmarks-with-a-web-service">Sync bookmarks with a web service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/System-integration.html#set-the-preferred-editor">Set the preferred editor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/System-integration.html#sync-database-across-systems">Sync database across systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Third-party-integration.html">Piped input</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Third-party-integration.html#fuzzy-search">Fuzzy search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Third-party-integration.html#cmder-integration-windows">cmder integration (Windows)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Upload-to-pypi.html">Buku 3.8 or newer with readme.md</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wiki/Upload-to-pypi.html#buku-3-7-or-older-with-readme-rst">Buku 3.7 or older with readme.rst</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Buku Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../buku.html">buku</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bukuserver Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../bukuserver.html">bukuserver</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">buku</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Module code</a> &raquo;</li>
      <li>buku</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for buku</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1">#</span>
<span class="c1"># Bookmark management utility</span>
<span class="c1">#</span>
<span class="c1"># Copyright Â© 2015-2022 Arun Prakash Jana &lt;engineerarun@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with buku.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">DEVNULL</span><span class="p">,</span> <span class="n">PIPE</span><span class="p">,</span> <span class="n">Popen</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">urllib3</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">urllib3.exceptions</span> <span class="kn">import</span> <span class="n">LocationParseError</span>
<span class="kn">from</span> <span class="nn">urllib3.util</span> <span class="kn">import</span> <span class="n">Retry</span><span class="p">,</span> <span class="n">make_headers</span><span class="p">,</span> <span class="n">parse_url</span>

<span class="c1"># note catch ModuleNotFoundError instead Exception</span>
<span class="c1"># when python3.5 not supported</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">readline</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyreadline</span> <span class="k">as</span> <span class="nn">readline</span>  <span class="c1"># type: ignore</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mypy_extensions</span> <span class="kn">import</span> <span class="n">TypedDict</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">TypedDict</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;4.6&#39;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;Arun Prakash Jana &lt;engineerarun@gmail.com&gt;&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s1">&#39;GPLv3&#39;</span>

<span class="c1"># Global variables</span>
<span class="n">INTERRUPTED</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Received SIGINT</span>
<span class="n">DELIM</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>  <span class="c1"># Delimiter used to store tags in DB</span>
<span class="n">SKIP_MIMES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">}</span>
<span class="n">PROMPTMSG</span> <span class="o">=</span> <span class="s1">&#39;buku (? for help): &#39;</span>  <span class="c1"># Prompt message string</span>

<span class="c1"># Default format specifiers to print records</span>
<span class="n">ID_STR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. </span><span class="si">%s</span><span class="s1"> [</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">ID_DB_STR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. </span><span class="si">%s</span><span class="s1">&#39;</span>
<span class="n">MUTE_STR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (L)</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">URL_STR</span> <span class="o">=</span> <span class="s1">&#39;   &gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">DESC_STR</span> <span class="o">=</span> <span class="s1">&#39;   + </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">DESC_WRAP</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span>
<span class="n">TAG_STR</span> <span class="o">=</span> <span class="s1">&#39;   # </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
<span class="n">TAG_WRAP</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span>

<span class="c1"># Colormap for color output from &quot;googler&quot; project</span>
<span class="n">COLORMAP</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[</span><span class="si">%s</span><span class="s1">m&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
    <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;30&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;31&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;32&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;33&#39;</span><span class="p">,</span>
    <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="s1">&#39;34&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="s1">&#39;35&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="s1">&#39;36&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="s1">&#39;37&#39;</span><span class="p">,</span>
    <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;90&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">:</span> <span class="s1">&#39;91&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="s1">&#39;92&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="s1">&#39;93&#39;</span><span class="p">,</span>
    <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="s1">&#39;94&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="s1">&#39;95&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="s1">&#39;96&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="s1">&#39;97&#39;</span><span class="p">,</span>
    <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;30;1&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="s1">&#39;31;1&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;32;1&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="s1">&#39;33;1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="s1">&#39;34;1&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="s1">&#39;35;1&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s1">&#39;36;1&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;37;1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="s1">&#39;90;1&#39;</span><span class="p">,</span> <span class="s1">&#39;J&#39;</span><span class="p">:</span> <span class="s1">&#39;91;1&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="s1">&#39;92;1&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="s1">&#39;93;1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="s1">&#39;94;1&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="s1">&#39;95;1&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="s1">&#39;96;1&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;97;1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="s1">&#39;7;1&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
<span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s1">&#39;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:89.0) Gecko/20100101 Firefox/89.0&#39;</span>
<span class="n">MYHEADERS</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Default dictionary of headers</span>
<span class="n">MYPROXY</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Default proxy</span>
<span class="n">TEXT_BROWSERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;elinks&#39;</span><span class="p">,</span> <span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="s1">&#39;links2&#39;</span><span class="p">,</span> <span class="s1">&#39;lynx&#39;</span><span class="p">,</span> <span class="s1">&#39;w3m&#39;</span><span class="p">,</span> <span class="s1">&#39;www-browser&#39;</span><span class="p">]</span>
<span class="n">IGNORE_FF_BOOKMARK_FOLDERS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="s2">&quot;placesRoot&quot;</span><span class="p">,</span> <span class="s2">&quot;bookmarksMenuFolder&quot;</span><span class="p">])</span>

<span class="c1"># Set up logging</span>
<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">LOGDBG</span> <span class="o">=</span> <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span>
<span class="n">LOGERR</span> <span class="o">=</span> <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span>

<span class="c1"># Define the default path to ca-certificates</span>
<span class="c1"># In Linux distros with openssl, it is /etc/ssl/certs/ca-certificates.crt</span>
<span class="c1"># Fall back to use `certifi` otherwise</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;/etc/ssl/certs/ca-certificates.crt&#39;</span><span class="p">):</span>
    <span class="n">CA_CERTS</span> <span class="o">=</span> <span class="s1">&#39;/etc/ssl/certs/ca-certificates.crt&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">certifi</span>
    <span class="n">CA_CERTS</span> <span class="o">=</span> <span class="n">certifi</span><span class="o">.</span><span class="n">where</span><span class="p">()</span>


<div class="viewcode-block" id="BukuCrypt"><a class="viewcode-back" href="../buku.html#buku.BukuCrypt">[docs]</a><span class="k">class</span> <span class="nc">BukuCrypt</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class to handle encryption and decryption of</span>
<span class="sd">    the database file. Functionally a separate entity.</span>

<span class="sd">    Involves late imports in the static functions but it</span>
<span class="sd">    saves ~100ms each time. Given that encrypt/decrypt are</span>
<span class="sd">    not done automatically and any one should be called at</span>
<span class="sd">    a time, this doesn&#39;t seem to be an outrageous approach.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    BLOCKSIZE</span>
<span class="sd">        64 KB blocks</span>
<span class="sd">    CHUNKSIZE</span>
<span class="sd">        Read/write 512 KB chunks</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Crypto constants</span>
    <span class="n">BLOCKSIZE</span> <span class="o">=</span> <span class="mh">0x10000</span>
    <span class="n">SALT_SIZE</span> <span class="o">=</span> <span class="mh">0x20</span>
    <span class="n">CHUNKSIZE</span> <span class="o">=</span> <span class="mh">0x80000</span>

<div class="viewcode-block" id="BukuCrypt.get_filehash"><a class="viewcode-back" href="../buku.html#buku.BukuCrypt.get_filehash">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_filehash</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the SHA256 hash of a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Path to the file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hash : bytes</span>
<span class="sd">            Hash digest of file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">hasher</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">()</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">BLOCKSIZE</span><span class="p">)</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">BLOCKSIZE</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuCrypt.encrypt_file"><a class="viewcode-back" href="../buku.html#buku.BukuCrypt.encrypt_file">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">encrypt_file</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Encrypt the bookmarks database file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations : int</span>
<span class="sd">            Number of iterations for key generation.</span>
<span class="sd">        dbfile : str, optional</span>
<span class="sd">            Custom database file path (including filename).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>
            <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

            <span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
            <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;cryptography lib(s) missing&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iterations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Iterations must be &gt;= 1&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbfile</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BukuDb</span><span class="o">.</span><span class="n">get_default_dbdir</span><span class="p">(),</span> <span class="s1">&#39;bookmarks.db&#39;</span><span class="p">)</span>
        <span class="n">encfile</span> <span class="o">=</span> <span class="n">dbfile</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span>

        <span class="n">db_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">enc_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">encfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enc_exists</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">db_exists</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> missing. Already encrypted?&#39;</span><span class="p">,</span> <span class="n">dbfile</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># db_exists and enc_exists</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Both encrypted and flat DB files exist!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">()</span>
        <span class="n">passconfirm</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">passconfirm</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Empty password&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password</span> <span class="o">!=</span> <span class="n">passconfirm</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Passwords do not match&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get SHA256 hash of DB file</span>
            <span class="n">dbhash</span> <span class="o">=</span> <span class="n">BukuCrypt</span><span class="o">.</span><span class="n">get_filehash</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Generate random 256-bit salt and key</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">SALT_SIZE</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

        <span class="n">iv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">encryptor</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
            <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
            <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
        <span class="n">filesize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">encfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfp</span><span class="p">:</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span>

                <span class="c1"># Embed DB file hash in encrypted file</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dbhash</span><span class="p">)</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">CHUNKSIZE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;%b%b&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">))</span>

                    <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>

                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">())</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File encrypted&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">encfile</span><span class="p">)</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuCrypt.decrypt_file"><a class="viewcode-back" href="../buku.html#buku.BukuCrypt.decrypt_file">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">decrypt_file</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">dbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decrypt the bookmarks database file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iterations : int</span>
<span class="sd">            Number of iterations for key generation.</span>
<span class="sd">        dbfile : str, optional</span>
<span class="sd">            Custom database file path (including filename).</span>
<span class="sd">            The &#39;.enc&#39; suffix must be omitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>
            <span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

            <span class="kn">from</span> <span class="nn">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
            <span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers</span> <span class="kn">import</span> <span class="n">Cipher</span><span class="p">,</span> <span class="n">algorithms</span><span class="p">,</span> <span class="n">modes</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;cryptography lib(s) missing&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iterations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Decryption failed&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbfile</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BukuDb</span><span class="o">.</span><span class="n">get_default_dbdir</span><span class="p">(),</span> <span class="s1">&#39;bookmarks.db&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="n">dbpath</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="n">encfile</span> <span class="o">=</span> <span class="n">dbfile</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span>

        <span class="n">enc_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">encfile</span><span class="p">)</span>
        <span class="n">db_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">enc_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">db_exists</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">enc_exists</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> missing&#39;</span><span class="p">,</span> <span class="n">encfile</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># db_exists and enc_exists</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Both encrypted and flat DB files exist!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Decryption failed&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">encfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Read 256-bit salt and generate key</span>
                <span class="n">salt</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">salt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">sha256</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>

                <span class="n">iv</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
                <span class="n">decryptor</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span>
                    <span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                    <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span>
                    <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">(),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>

                <span class="c1"># Get original DB file&#39;s SHA256 hash from encrypted file</span>
                <span class="n">enchash</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfp</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="n">infp</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">BukuCrypt</span><span class="o">.</span><span class="n">CHUNKSIZE</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
                    <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">decryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">())</span>
                    <span class="n">outfp</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

            <span class="c1"># Match hash of generated file with that of original DB file</span>
            <span class="n">dbhash</span> <span class="o">=</span> <span class="n">BukuCrypt</span><span class="o">.</span><span class="n">get_filehash</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dbhash</span> <span class="o">!=</span> <span class="n">enchash</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Decryption failed&#39;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">encfile</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File decrypted&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">struct</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Tainted file&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div></div>


<span class="n">BookmarkVar</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="c1"># example:</span>
<span class="c1"># (1, &#39;http://example.com&#39;, &#39;example title&#39;, &#39;,tags1,&#39;, &#39;randomdesc&#39;, 0))</span>


<div class="viewcode-block" id="BukuDb"><a class="viewcode-back" href="../buku.html#buku.BukuDb">[docs]</a><span class="k">class</span> <span class="nc">BukuDb</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Abstracts all database operations.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    conn : sqlite database connection.</span>
<span class="sd">    cur : sqlite database cursor.</span>
<span class="sd">    json : string</span>
<span class="sd">        Empty string if results should be printed in JSON format to stdout.</span>
<span class="sd">        Nonempty string if results should be printed in JSON format to file. The string has to be a valid path.</span>
<span class="sd">        None if the results should be printed as human-readable plaintext.</span>
<span class="sd">    field_filter : int</span>
<span class="sd">        Indicates format for displaying bookmarks. Default is 0.</span>
<span class="sd">    chatty : bool</span>
<span class="sd">        Sets the verbosity of the APIs. Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">field_filter</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chatty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">dbfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">colorize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Database initialization API.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json : string</span>
<span class="sd">            Empty string if results should be printed in JSON format to stdout.</span>
<span class="sd">            Nonempty string if results should be printed in JSON format to file. The string has to be a valid path.</span>
<span class="sd">            None if the results should be printed as human-readable plaintext.</span>
<span class="sd">        field_filter : int, optional</span>
<span class="sd">            Indicates format for displaying bookmarks. Default is 0.</span>
<span class="sd">        chatty : bool, optional</span>
<span class="sd">            Sets the verbosity of the APIs. Default is False.</span>
<span class="sd">        colorize : bool, optional</span>
<span class="sd">            Indicates whether color should be used in output. Default is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="n">json</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span> <span class="o">=</span> <span class="n">field_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="n">chatty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span> <span class="o">=</span> <span class="n">colorize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">BukuDb</span><span class="o">.</span><span class="n">initdb</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">)</span>

<div class="viewcode-block" id="BukuDb.get_default_dbdir"><a class="viewcode-back" href="../buku.html#buku.BukuDb.get_default_dbdir">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_default_dbdir</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Determine the directory path where dbfile will be stored.</span>

<span class="sd">        If the platform is Windows, use %APPDATA%</span>
<span class="sd">        else if $XDG_DATA_HOME is defined, use it</span>
<span class="sd">        else if $HOME exists, use it</span>
<span class="sd">        else use the current directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Path to database file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;XDG_DATA_HOME&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_home</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
                    <span class="n">data_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;APPDATA&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data_home</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HOME&#39;</span><span class="p">),</span> <span class="s1">&#39;.local&#39;</span><span class="p">,</span> <span class="s1">&#39;share&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_home</span><span class="p">,</span> <span class="s1">&#39;buku&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.initdb"><a class="viewcode-back" href="../buku.html#buku.BukuDb.initdb">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">initdb</span><span class="p">(</span><span class="n">dbfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chatty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">Connection</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Cursor</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Initialize the database connection.</span>

<span class="sd">        Create DB file and/or bookmarks table if they don&#39;t exist.</span>
<span class="sd">        Alert on encryption options on first execution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dbfile : str, optional</span>
<span class="sd">            Custom database file path (including filename).</span>
<span class="sd">        chatty : bool</span>
<span class="sd">            If True, shows informative message on DB creation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (connection, cursor).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbfile</span><span class="p">:</span>
            <span class="n">dbpath</span> <span class="o">=</span> <span class="n">BukuDb</span><span class="o">.</span><span class="n">get_default_dbdir</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;bookmarks.db&#39;</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dbpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
            <span class="n">dbpath</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbpath</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">db_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span><span class="p">)</span>
        <span class="n">enc_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dbfile</span> <span class="o">+</span> <span class="s1">&#39;.enc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">enc_exists</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">enc_exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">db_exists</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Unlock database first&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">db_exists</span> <span class="ow">and</span> <span class="n">enc_exists</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Both encrypted and flat DB files exist!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">chatty</span><span class="p">:</span>
            <span class="c1"># not db_exists and not enc_exists</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DB file is being created at </span><span class="si">%s</span><span class="s1">.</span><span class="se">\n</span><span class="s1">You should encrypt it.&#39;</span> <span class="o">%</span> <span class="n">dbfile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a connection</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="s1">&#39;REGEXP&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">regexp</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c1"># Create table if it doesn&#39;t exist</span>
            <span class="c1"># flags: designed to be extended in future using bitwise masks</span>
            <span class="c1"># Masks:</span>
            <span class="c1">#     0b00000001: set title immutable</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;CREATE TABLE if not exists bookmarks (&#39;</span>
                        <span class="s1">&#39;id integer PRIMARY KEY, &#39;</span>
                        <span class="s1">&#39;URL text NOT NULL UNIQUE, &#39;</span>
                        <span class="s1">&#39;metadata text default </span><span class="se">\&#39;\&#39;</span><span class="s1">, &#39;</span>
                        <span class="s1">&#39;tags text default </span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="s1">, &#39;</span>
                        <span class="s1">&#39;desc text default </span><span class="se">\&#39;\&#39;</span><span class="s1">, &#39;</span>
                        <span class="s1">&#39;flags integer default 0)&#39;</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;initdb(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.get_rec_all"><a class="viewcode-back" href="../buku.html#buku.BukuDb.get_rec_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_rec_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all the bookmarks in the database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of tuples representing bookmark records.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM bookmarks&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.get_rec_by_id"><a class="viewcode-back" href="../buku.html#buku.BukuDb.get_rec_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_rec_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BookmarkVar</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get a bookmark from database by its ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of bookmark record.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple or None</span>
<span class="sd">            Bookmark data, or None if index is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM bookmarks WHERE id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resultset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">resultset</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BukuDb.get_rec_id"><a class="viewcode-back" href="../buku.html#buku.BukuDb.get_rec_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_rec_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if URL already exists in DB.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">            A URL to search for in the DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            DB index, or -1 if URL not found in DB.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id FROM bookmarks WHERE URL = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">url</span><span class="p">,))</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resultset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">resultset</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="BukuDb.get_max_id"><a class="viewcode-back" href="../buku.html#buku.BukuDb.get_max_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Fetch the ID of the last record.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            ID of the record if any record exists, else -1.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT MAX(id) from bookmarks&#39;</span><span class="p">)</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">resultset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">resultset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="BukuDb.add_rec"><a class="viewcode-back" href="../buku.html#buku.BukuDb.add_rec">[docs]</a>    <span class="k">def</span> <span class="nf">add_rec</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">title_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">tags_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">desc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">immutable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">delay_commit</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">fetch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a new bookmark.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        url : str</span>
<span class="sd">            URL to bookmark.</span>
<span class="sd">        title_in :str, optional</span>
<span class="sd">            Title to add manually. Default is None.</span>
<span class="sd">        tags_in : str, optional</span>
<span class="sd">            Comma-separated tags to add manually.</span>
<span class="sd">            Must start and end with comma. Default is None.</span>
<span class="sd">        desc : str, optional</span>
<span class="sd">            Description of the bookmark. Default is None.</span>
<span class="sd">        immutable : int, optional</span>
<span class="sd">            Indicates whether to disable title fetch from web.</span>
<span class="sd">            Default is 0.</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>
<span class="sd">        fetch : bool, optional</span>
<span class="sd">            Fetch page from web and parse for data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            DB index of new bookmark on success, -1 on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Return error for empty URL</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span> <span class="ow">or</span> <span class="n">url</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Invalid URL&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Ensure that the URL does not exist in DB already</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rec_id</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;URL [</span><span class="si">%s</span><span class="s1">] already exists at index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">fetch</span><span class="p">:</span>
            <span class="c1"># Fetch data</span>
            <span class="n">ptitle</span><span class="p">,</span> <span class="n">pdesc</span><span class="p">,</span> <span class="n">ptags</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">network_handler</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Malformed URL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mime</span><span class="p">:</span>
                <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;HTTP HEAD requested&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ptitle</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">title_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No title</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;Title: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">ptitle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ptitle</span> <span class="o">=</span> <span class="n">pdesc</span> <span class="o">=</span> <span class="n">ptags</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;ptags: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">ptags</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">title_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ptitle</span> <span class="o">=</span> <span class="n">title_in</span>

        <span class="c1"># Fix up tags, if broken</span>
        <span class="n">tags_in</span> <span class="o">=</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tags_in</span><span class="p">)</span>

        <span class="c1"># Process description</span>
        <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">pdesc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pdesc</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">flagset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">immutable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">flagset</span> <span class="o">|=</span> <span class="n">immutable</span>

            <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO bookmarks(URL, metadata, tags, desc, flags) VALUES (?, ?, ?, ?, ?)&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">ptitle</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">flagset</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">lastrowid</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;add_rec(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="BukuDb.append_tag_at_index"><a class="viewcode-back" href="../buku.html#buku.BukuDb.append_tag_at_index">[docs]</a>    <span class="k">def</span> <span class="nf">append_tag_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append tags to bookmark tagset at index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of the record. 0 indicates all records.</span>
<span class="sd">        tags_in : str</span>
<span class="sd">            Comma-separated tags to add manually.</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tags_in</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Append the tags to ALL bookmarks? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, tags FROM bookmarks ORDER BY id ASC&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, tags FROM bookmarks WHERE id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>

        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.delete_tag_at_index"><a class="viewcode-back" href="../buku.html#buku.BukuDb.delete_tag_at_index">[docs]</a>    <span class="k">def</span> <span class="nf">delete_tag_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chatty</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete tags from bookmark tagset at index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of bookmark record. 0 indicates all records.</span>
<span class="sd">        tags_in : str</span>
<span class="sd">            Comma-separated tags to delete manually.</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>
<span class="sd">        chatty: bool, optional</span>
<span class="sd">            Skip confirmation when set to False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tags_in</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">tags_to_delete</span> <span class="o">=</span> <span class="n">tags_in</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chatty</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Delete the tag(s) from ALL bookmarks? (y/n): &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">match</span> <span class="o">=</span> <span class="s2">&quot;&#39;%&#39; || ? || &#39;%&#39;&quot;</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_to_delete</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;UPDATE bookmarks SET tags = replace(tags, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;) &quot;</span>
                     <span class="s2">&quot;WHERE tags LIKE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">DELIM</span><span class="p">,</span> <span class="n">match</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>

            <span class="k">if</span> <span class="n">count</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> record(s) updated&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Process a single index</span>
        <span class="c1"># Use SELECT and UPDATE to handle multiple tags at once</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, tags FROM bookmarks WHERE id = ? LIMIT 1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_to_delete</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">delim_wrap</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span> <span class="n">DELIM</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">]),</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.update_rec"><a class="viewcode-back" href="../buku.html#buku.BukuDb.update_rec">[docs]</a>    <span class="k">def</span> <span class="nf">update_rec</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">title_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">tags_in</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">desc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">immutable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update an existing record at index.</span>

<span class="sd">        Update all records if index is 0 and url is not specified.</span>
<span class="sd">        URL is an exception because URLs are unique in DB.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of record. 0 indicates all records.</span>
<span class="sd">        url : str, optional</span>
<span class="sd">            Bookmark address.</span>
<span class="sd">        title_in : str, optional</span>
<span class="sd">            Title to add manually.</span>
<span class="sd">        tags_in : str, optional</span>
<span class="sd">            Comma-separated tags to add manually. Must start and end with comma.</span>
<span class="sd">            Prefix with &#39;+,&#39; to append to current tags.</span>
<span class="sd">            Prefix with &#39;-,&#39; to delete from current tags.</span>
<span class="sd">        desc : str, optional</span>
<span class="sd">            Description of bookmark.</span>
<span class="sd">        immutable : int, optional</span>
<span class="sd">            Disable title fetch from web if 1. Default is -1.</span>
<span class="sd">        threads : int, optional</span>
<span class="sd">            Number of threads to use to refresh full DB. Default is 4.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on Failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Any]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET&#39;</span>
        <span class="n">to_update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">tag_modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Update URL if passed as argument</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">url</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;All URLs cannot be same&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; URL = ?,&#39;</span>
            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">url</span><span class="p">,)</span>
            <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update tags if passed as argument</span>
        <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;+,&#39;</span><span class="p">,</span> <span class="s1">&#39;-,&#39;</span><span class="p">):</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Please specify a tag&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">tags_in</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;+,&#39;</span><span class="p">):</span>
                <span class="n">chatty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_tag_at_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="n">chatty</span>
                <span class="n">tag_modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">tags_in</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-,&#39;</span><span class="p">):</span>
                <span class="n">chatty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span> <span class="o">=</span> <span class="n">chatty</span>
                <span class="n">tag_modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tags_in</span> <span class="o">=</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tags_in</span><span class="p">)</span>

                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; tags = ?,&#39;</span>
                <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tags_in</span><span class="p">,)</span>
                <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update description if passed as an argument</span>
        <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; desc = ?,&#39;</span>
            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">desc</span><span class="p">,)</span>
            <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update immutable flag if passed as argument</span>
        <span class="k">if</span> <span class="n">immutable</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">flagset</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">immutable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; flags = flags | ?,&#39;</span>
            <span class="k">elif</span> <span class="n">immutable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; flags = flags &amp; ?,&#39;</span>
                <span class="n">flagset</span> <span class="o">=</span> <span class="o">~</span><span class="n">flagset</span>

            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">flagset</span><span class="p">,)</span>
            <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Update title</span>
        <span class="c1">#</span>
        <span class="c1"># 1. If --title has no arguments, delete existing title</span>
        <span class="c1"># 2. If --title has arguments, update existing title</span>
        <span class="c1"># 3. If --title option is omitted at cmdline:</span>
        <span class="c1">#    If URL is passed, update the title from web using the URL</span>
        <span class="c1"># 4. If no other argument (url, tag, comment, immutable) passed,</span>
        <span class="c1">#    update title from web using DB URL (if title is mutable)</span>
        <span class="n">title_to_insert</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pdesc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ptags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">title_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title_to_insert</span> <span class="o">=</span> <span class="n">title_in</span>
        <span class="k">elif</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">url</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">title_to_insert</span><span class="p">,</span> <span class="n">pdesc</span><span class="p">,</span> <span class="n">ptags</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">network_handler</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Malformed URL&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mime</span><span class="p">:</span>
                <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;HTTP HEAD requested&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">title_to_insert</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No title&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;Title: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">title_to_insert</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pdesc</span><span class="p">:</span>
                    <span class="n">pdesc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; desc = ?,&#39;</span>
                <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pdesc</span><span class="p">,)</span>
                <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">to_update</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tag_modified</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refreshdb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="ow">and</span> <span class="n">index</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">if</span> <span class="n">title_to_insert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; metadata = ?,&#39;</span>
            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">title_to_insert</span><span class="p">,)</span>
            <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_update</span><span class="p">:</span>  <span class="c1"># Nothing to update</span>
            <span class="c1"># Show bookmark if tags were appended to deleted</span>
            <span class="k">if</span> <span class="n">tag_modified</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Update all records</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Update ALL bookmarks? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; WHERE id = ?&#39;</span>
            <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">index</span><span class="p">,)</span>

        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;update_rec query: &quot;</span><span class="si">%s</span><span class="s1">&quot;, args: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;URL already exists&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.refreshdb"><a class="viewcode-back" href="../buku.html#buku.BukuDb.refreshdb">[docs]</a>    <span class="k">def</span> <span class="nf">refreshdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">threads</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Refresh ALL records in the database.</span>

<span class="sd">        Fetch title for each bookmark from the web and update the records.</span>
<span class="sd">        Doesn&#39;t update the record if fetched title is empty.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            This API doesn&#39;t change DB index, URL or tags of a bookmark.</span>
<span class="sd">            This API is verbose.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of record to update. 0 indicates all records.</span>
<span class="sd">        threads: int</span>
<span class="sd">            Number of threads to use to refresh full DB. Default is 4.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, url, flags FROM bookmarks ORDER BY id ASC&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, url, flags FROM bookmarks WHERE id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>

        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultset</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recs</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index or title immutable or empty DB&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Set up strings to be printed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colorize</span><span class="p">:</span>
            <span class="n">bad_url_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[1mIndex </span><span class="si">%d</span><span class="s1">: Malformed URL</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">mime_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[1mIndex </span><span class="si">%d</span><span class="s1">: HTTP HEAD requested</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">blank_url_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[1mIndex </span><span class="si">%d</span><span class="s1">: No title</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">success_str</span> <span class="o">=</span> <span class="s1">&#39;Title: [</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n\x1b</span><span class="s1">[92mIndex </span><span class="si">%d</span><span class="s1">: updated</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bad_url_str</span> <span class="o">=</span> <span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">: Malformed URL</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">mime_str</span> <span class="o">=</span> <span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">: HTTP HEAD requested</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">blank_url_str</span> <span class="o">=</span> <span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">: No title</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">success_str</span> <span class="o">=</span> <span class="s1">&#39;Title: [</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">Index </span><span class="si">%d</span><span class="s1">: updated</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">done</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>  <span class="c1"># count threads completed</span>
        <span class="n">processed</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>  <span class="c1"># count number of records processed</span>

        <span class="c1"># An additional call to generate default headers</span>
        <span class="c1"># gen_headers() is called within network_handler()</span>
        <span class="c1"># However, this initial call to setup headers</span>
        <span class="c1"># ensures there is no race condition among the</span>
        <span class="c1"># initial threads to setup headers</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">MYHEADERS</span><span class="p">:</span>
            <span class="n">gen_headers</span><span class="p">()</span>

        <span class="n">cond</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>
        <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Inner function to fetch titles and update records.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            count : int</span>
<span class="sd">                Dummy input to adhere to convention.</span>
<span class="sd">            cond : threading condition object.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET&#39;</span>
                <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">resultset</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">resultset</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                <span class="n">title</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">mime</span><span class="p">,</span> <span class="n">bad</span> <span class="o">=</span> <span class="n">network_handler</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">cond</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">bad_url_str</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">mime</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">mime_str</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">continue</span>

                <span class="n">to_update</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">or</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">LOGERR</span><span class="p">(</span><span class="n">blank_url_str</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; metadata = ?,&#39;</span>
                    <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">title</span><span class="p">,)</span>
                    <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; desc = ?,&#39;</span>
                    <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">desc</span><span class="p">,)</span>
                    <span class="n">to_update</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">to_update</span><span class="p">:</span>
                    <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">continue</span>

                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; WHERE id = ?&#39;</span>
                <span class="n">arguments</span> <span class="o">+=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],)</span>
                <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;refreshdb query: &quot;</span><span class="si">%s</span><span class="s1">&quot;, args: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>

                <span class="c1"># Save after fetching 32 titles per thread</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="mb">0b11111</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">success_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">INTERRUPTED</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;Thread </span><span class="si">%d</span><span class="s1">: processed </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">cond</span><span class="p">:</span>
                <span class="n">done</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">processed</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">recs</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="n">recs</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
            <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">refresh</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cond</span><span class="p">))</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">done</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> threads completed&#39;</span><span class="p">,</span> <span class="n">done</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

        <span class="c1"># Guard: records found == total records processed</span>
        <span class="k">if</span> <span class="n">recs</span> <span class="o">!=</span> <span class="n">processed</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Records: </span><span class="si">%d</span><span class="s1">, processed: </span><span class="si">%d</span><span class="s1"> !!!&#39;</span><span class="p">,</span> <span class="n">recs</span><span class="p">,</span> <span class="n">processed</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

        <span class="n">cond</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.edit_update_rec"><a class="viewcode-back" href="../buku.html#buku.BukuDb.edit_update_rec">[docs]</a>    <span class="k">def</span> <span class="nf">edit_update_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">immutable</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Edit in editor and update a record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of the record.</span>
<span class="sd">            Last record, if index is -1.</span>
<span class="sd">        immutable : int, optional</span>
<span class="sd">            Diable title fetch from web if 1. Default is -1.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if updated, else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">editor</span> <span class="o">=</span> <span class="n">get_system_editor</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">editor</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;EDITOR must be set to use index with -w&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Edit the last records</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Empty database&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rec_by_id</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># If reading from DB, show empty title and desc as empty lines. We have to convert because</span>
        <span class="c1"># even in case of add with a blank title or desc, &#39;&#39; is used as initializer to show &#39;-&#39;.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">edit_rec</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">rec</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">rec</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">immutable</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">immutable</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">immutable</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BukuDb.list_using_id"><a class="viewcode-back" href="../buku.html#buku.BukuDb.list_using_id">[docs]</a>    <span class="k">def</span> <span class="nf">list_using_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;List entries in the DB using the specified id list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ids : list of ids in string form</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q0</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM bookmarks&#39;</span>
        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">q0</span> <span class="o">+=</span> <span class="s1">&#39; WHERE id in (&#39;</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">part_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
                        <span class="n">part_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">part_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">part_ids</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">qtemp</span> <span class="o">=</span> <span class="s1">&#39;SELECT id FROM bookmarks ORDER BY id DESC limit </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qtemp</span><span class="p">,</span> <span class="p">[])</span>
                        <span class="n">part_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()))</span>
                    <span class="n">q0</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">part_ids</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q0</span> <span class="o">+=</span> <span class="n">idx</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">q0</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q0</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.searchdb"><a class="viewcode-back" href="../buku.html#buku.BukuDb.searchdb">[docs]</a>    <span class="k">def</span> <span class="nf">searchdb</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">keywords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">all_keywords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">deep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">regex</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Search DB for entries where tags, URL, or title fields match keywords.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keywords : list of str</span>
<span class="sd">            Keywords to search.</span>
<span class="sd">        all_keywords : bool, optional</span>
<span class="sd">            True to return records matching ALL keywords.</span>
<span class="sd">            False (default value) to return records matching ANY keyword.</span>
<span class="sd">        deep : bool, optional</span>
<span class="sd">            True to search for matching substrings. Default is False.</span>
<span class="sd">        regex : bool, optional</span>
<span class="sd">            Match a regular expression if True. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or None</span>
<span class="sd">            List of search results, or None if no matches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Deep query string</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;(tags LIKE (&#39;%&#39; || ? || &#39;%&#39;) OR &quot;</span>
              <span class="s2">&quot;URL LIKE (&#39;%&#39; || ? || &#39;%&#39;) OR &quot;</span>
              <span class="s2">&quot;metadata LIKE (&#39;%&#39; || ? || &#39;%&#39;) OR &quot;</span>
              <span class="s2">&quot;desc LIKE (&#39;%&#39; || ? || &#39;%&#39;)) &quot;</span><span class="p">)</span>
        <span class="c1"># Non-deep query string</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;(tags REGEXP ? OR &#39;</span>
              <span class="s1">&#39;URL REGEXP ? OR &#39;</span>
              <span class="s1">&#39;metadata REGEXP ? OR &#39;</span>
              <span class="s1">&#39;desc REGEXP ?) &#39;</span><span class="p">)</span>
        <span class="n">qargs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Any]</span>

        <span class="n">case_statement</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;CASE WHEN &#39;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39; THEN 1 ELSE 0 END&#39;</span>
        <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, url, metadata, tags, desc, flags FROM (SELECT *, &#39;</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">q0</span> <span class="o">+=</span> <span class="n">case_statement</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span>
                <span class="n">qargs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">qargs</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; AS score FROM bookmarks WHERE score &gt; 0 ORDER BY score DESC)&#39;</span>
        <span class="k">elif</span> <span class="n">all_keywords</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;blank&#39;</span><span class="p">:</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="s2">&quot;SELECT * FROM bookmarks WHERE metadata = &#39;&#39; OR tags = ? &quot;</span>
                <span class="n">qargs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">DELIM</span><span class="p">,)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;immutable&#39;</span><span class="p">:</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM bookmarks WHERE flags &amp; 1 == 1 &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, url, metadata, tags, desc, flags FROM bookmarks WHERE &#39;</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
                        <span class="n">q0</span> <span class="o">+=</span> <span class="n">q1</span> <span class="o">+</span> <span class="s1">&#39;AND &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_pre</span> <span class="o">=</span> <span class="n">_post</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">_pre</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">b&#39;</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">_post</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">b&#39;</span>
                        <span class="n">token</span> <span class="o">=</span> <span class="n">_pre</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="n">_post</span>
                        <span class="n">q0</span> <span class="o">+=</span> <span class="n">q2</span> <span class="o">+</span> <span class="s1">&#39;AND &#39;</span>

                    <span class="n">qargs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">qargs</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>

                <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">q0</span> <span class="o">+=</span> <span class="s1">&#39;ORDER BY id ASC&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">all_keywords</span><span class="p">:</span>
            <span class="n">q0</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, url, metadata, tags, desc, flags FROM (SELECT *, &#39;</span>
            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">keywords</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
                    <span class="n">q0</span> <span class="o">+=</span> <span class="n">case_statement</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_pre</span> <span class="o">=</span> <span class="n">_post</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">_pre</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">b&#39;</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">_post</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">b&#39;</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">_pre</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="n">_post</span>
                    <span class="n">q0</span> <span class="o">+=</span> <span class="n">case_statement</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span>

                <span class="n">qargs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">qargs</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">q0</span> <span class="o">=</span> <span class="n">q0</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; AS score FROM bookmarks WHERE score &gt; 0 ORDER BY score DESC)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Invalid search option&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;query: &quot;</span><span class="si">%s</span><span class="s1">&quot;, args: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">qargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q0</span><span class="p">,</span> <span class="n">qargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.search_by_tag"><a class="viewcode-back" href="../buku.html#buku.BukuDb.search_by_tag">[docs]</a>    <span class="k">def</span> <span class="nf">search_by_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">BookmarkVar</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Search bookmarks for entries with given tags.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tags : str</span>
<span class="sd">            String of tags to search for.</span>
<span class="sd">            Retrieves entries matching ANY tag if tags are</span>
<span class="sd">            delimited with &#39;,&#39;.</span>
<span class="sd">            Retrieves entries matching ALL tags if tags are</span>
<span class="sd">            delimited with &#39;+&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or None</span>
<span class="sd">            List of search results, or None if no matches.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGDBG</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tags</span> <span class="o">==</span> <span class="n">DELIM</span> <span class="ow">or</span> <span class="n">tags</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">tags_</span><span class="p">,</span> <span class="n">search_operator</span><span class="p">,</span> <span class="n">excluded_tags</span> <span class="o">=</span> <span class="n">prep_tag_search</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">search_operator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s2">&quot;Cannot use both &#39;+&#39; and &#39;,&#39; in same search&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;tags: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tags_</span><span class="p">)</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;search_operator: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">search_operator</span><span class="p">)</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;excluded_tags: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">excluded_tags</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">search_operator</span> <span class="o">==</span> <span class="s1">&#39;AND&#39;</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT id, url, metadata, tags, desc, flags FROM bookmarks &quot;</span>
                     <span class="s2">&quot;WHERE tags LIKE &#39;%&#39; || ? || &#39;%&#39; &quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> tags LIKE &#39;%&#39; || ? || &#39;%&#39; &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">search_operator</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">excluded_tags</span><span class="p">:</span>
                <span class="n">tags_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excluded_tags</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;WHERE tags&#39;</span><span class="p">,</span> <span class="s1">&#39;WHERE (tags&#39;</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39;) AND tags NOT REGEXP ? &#39;</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39;ORDER BY id ASC&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, url, metadata, tags, desc, flags FROM (SELECT *, &#39;</span>
            <span class="n">case_statement</span> <span class="o">=</span> <span class="s2">&quot;CASE WHEN tags LIKE &#39;%&#39; || ? || &#39;%&#39; THEN 1 ELSE 0 END&quot;</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="n">case_statement</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">case_statement</span>

            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; AS score FROM bookmarks WHERE score &gt; 0&#39;</span>

            <span class="k">if</span> <span class="n">excluded_tags</span><span class="p">:</span>
                <span class="n">tags_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excluded_tags</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; AND tags NOT REGEXP ? &#39;</span>

            <span class="n">query</span> <span class="o">+=</span> <span class="s1">&#39; ORDER BY score DESC)&#39;</span>

        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;query: &quot;</span><span class="si">%s</span><span class="s1">&quot;, args: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">tags_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tags_</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.search_keywords_and_filter_by_tags"><a class="viewcode-back" href="../buku.html#buku.BukuDb.search_keywords_and_filter_by_tags">[docs]</a>    <span class="k">def</span> <span class="nf">search_keywords_and_filter_by_tags</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">keywords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
            <span class="n">all_keywords</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">deep</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">regex</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">stag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">BookmarkVar</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Search bookmarks for entries with keywords and specified</span>
<span class="sd">        criteria while filtering out entries with matching tags.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keywords : list of str</span>
<span class="sd">            Keywords to search.</span>
<span class="sd">        all_keywords : bool, optional</span>
<span class="sd">            True to return records matching ALL keywords.</span>
<span class="sd">            False to return records matching ANY keyword.</span>
<span class="sd">        deep : bool, optional</span>
<span class="sd">            True to search for matching substrings.</span>
<span class="sd">        regex : bool, optional</span>
<span class="sd">            Match a regular expression if True.</span>
<span class="sd">        stag : str</span>
<span class="sd">            String of tags to search for.</span>
<span class="sd">            Retrieves entries matching ANY tag if tags are</span>
<span class="sd">            delimited with &#39;,&#39;.</span>
<span class="sd">            Retrieves entries matching ALL tags if tags are</span>
<span class="sd">            delimited with &#39;+&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or None</span>
<span class="sd">            List of search results, or None if no matches.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keyword_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">keywords</span><span class="p">,</span> <span class="n">all_keywords</span><span class="p">,</span> <span class="n">deep</span><span class="p">,</span> <span class="n">regex</span><span class="p">)</span>
        <span class="n">keyword_results</span> <span class="o">=</span> <span class="n">keyword_results</span> <span class="k">if</span> <span class="n">keyword_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">stag_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_by_tag</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stag</span><span class="p">))</span>
        <span class="n">stag_results</span> <span class="o">=</span> <span class="n">stag_results</span> <span class="k">if</span> <span class="n">stag_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">keyword_results</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">stag_results</span><span class="p">))</span></div>

<div class="viewcode-block" id="BukuDb.exclude_results_from_search"><a class="viewcode-back" href="../buku.html#buku.BukuDb.exclude_results_from_search">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_results_from_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_results</span><span class="p">,</span> <span class="n">without</span><span class="p">,</span> <span class="n">deep</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Excludes records that match keyword search using without parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        search_results : list</span>
<span class="sd">            List of search results</span>
<span class="sd">        without : list of str</span>
<span class="sd">            Keywords to search.</span>
<span class="sd">        deep : bool, optional</span>
<span class="sd">            True to search for matching substrings.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list or None</span>
<span class="sd">            List of search results, or None if no matches.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">search_results</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">without</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">deep</span><span class="p">)))</span></div>

<div class="viewcode-block" id="BukuDb.compactdb"><a class="viewcode-back" href="../buku.html#buku.BukuDb.compactdb">[docs]</a>    <span class="k">def</span> <span class="nf">compactdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">delay_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When an entry at index is deleted, move the</span>
<span class="sd">        last entry in DB to index, if index is lesser.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            DB index of deleted entry.</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Return if the last index left in DB was just deleted</span>
        <span class="n">max_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_id</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">max_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">query1</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, URL, metadata, tags, desc, flags FROM bookmarks WHERE id = ? LIMIT 1&#39;</span>
        <span class="n">query2</span> <span class="o">=</span> <span class="s1">&#39;DELETE FROM bookmarks WHERE id = ?&#39;</span>
        <span class="n">query3</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO bookmarks(id, URL, metadata, tags, desc, flags) VALUES (?, ?, ?, ?, ?, ?)&#39;</span>

        <span class="c1"># NOOP if the just deleted index was the last one</span>
        <span class="k">if</span> <span class="n">max_id</span> <span class="o">&gt;</span> <span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query1</span><span class="p">,</span> <span class="p">(</span><span class="n">max_id</span><span class="p">,))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query2</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query3</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1"> moved to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="p">))</span></div>

<div class="viewcode-block" id="BukuDb.delete_rec"><a class="viewcode-back" href="../buku.html#buku.BukuDb.delete_rec">[docs]</a>    <span class="k">def</span> <span class="nf">delete_rec</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">low</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">high</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">is_range</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">delay_commit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Delete a single record or remove the table if index is 0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int, optional</span>
<span class="sd">            DB index of deleted entry.</span>
<span class="sd">        low : int, optional</span>
<span class="sd">            Actual lower index of range.</span>
<span class="sd">        high : int, optional</span>
<span class="sd">            Actual higher index of range.</span>
<span class="sd">        is_range : bool, optional</span>
<span class="sd">            A range is passed using low and high arguments.</span>
<span class="sd">            An index is ignored if is_range is True.</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If any of index, low, or high variable is not integer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from tempfile import NamedTemporaryFile</span>
<span class="sd">        &gt;&gt;&gt; import buku</span>
<span class="sd">        &gt;&gt;&gt; sdb = buku.BukuDb(dbfile=NamedTemporaryFile().name)  # single record database</span>
<span class="sd">        &gt;&gt;&gt; sdb.add_rec(&#39;https://example.com&#39;)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; sdb.delete_rec(1)</span>
<span class="sd">        Index 1 deleted</span>
<span class="sd">        True</span>

<span class="sd">        Delete record with default range.</span>

<span class="sd">        &gt;&gt;&gt; sdb = buku.BukuDb(dbfile=NamedTemporaryFile().name)</span>
<span class="sd">        &gt;&gt;&gt; sdb.add_rec(&#39;https://example.com&#39;)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; sdb.delete_rec(is_range=True)  # doctest: +SKIP</span>
<span class="sd">        Remove ALL bookmarks? (y/n): y</span>
<span class="sd">        All bookmarks deleted</span>
<span class="sd">        True</span>

<span class="sd">        Running the function without any parameter will raise TypeError.</span>

<span class="sd">        &gt;&gt;&gt; sdb = buku.BukuDb(dbfile=NamedTemporaryFile().name)</span>
<span class="sd">        &gt;&gt;&gt; sdb.add_rec(&#39;https://example.com&#39;)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; sdb.delete_rec()</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">        TypeError: index, low, or high variable is not integer</span>

<span class="sd">        Negative number on `high` and `low` paramaters when is_range is True</span>
<span class="sd">        will log error and return False</span>

<span class="sd">        &gt;&gt;&gt; edb = buku.BukuDb(dbfile=NamedTemporaryFile().name)</span>
<span class="sd">        &gt;&gt;&gt; edb.delete_rec(low=-1, high=-1, is_range=True)</span>
<span class="sd">        False</span>

<span class="sd">        Remove the table</span>

<span class="sd">        &gt;&gt;&gt; sdb = buku.BukuDb(dbfile=NamedTemporaryFile().name)</span>
<span class="sd">        &gt;&gt;&gt; sdb.delete_rec(0)  # doctest: +SKIP</span>
<span class="sd">        Remove ALL bookmarks? (y/n): y</span>
<span class="sd">        All bookmarks deleted</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_range</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="n">params</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;index, low, or high variable is not integer&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_range</span><span class="p">:</span>  <span class="c1"># Delete a range of indices</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Negative range boundary&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span>

            <span class="c1"># If range starts from 0, delete all records</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleardb</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT COUNT(*) from bookmarks where id &#39;</span>
                                     <span class="s1">&#39;BETWEEN ? AND ?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">: 0 deleted&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Delete these bookmarks? (y/n): &#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>

                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;DELETE from bookmarks where id BETWEEN ? AND ?&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">: </span><span class="si">%d</span><span class="s1"> deleted&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="c1"># Compact DB by ascending order of index to ensure</span>
                <span class="c1"># the existing higher indices move only once</span>
                <span class="c1"># Delayed commit is forced</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compactdb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Remove the table</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleardb</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Remove a single entry</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT COUNT(*) FROM bookmarks WHERE &#39;</span>
                                     <span class="s1">&#39;id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Delete this bookmark? (y/n): &#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">False</span>

                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;DELETE FROM bookmarks WHERE id = ?&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1"> deleted&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compactdb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.delete_resultset"><a class="viewcode-back" href="../buku.html#buku.BukuDb.delete_resultset">[docs]</a>    <span class="k">def</span> <span class="nf">delete_resultset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete search results in descending order of DB index.</span>

<span class="sd">        Indices are expected to be unique and in ascending order.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            This API forces a delayed commit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        results : list of tuples</span>
<span class="sd">            List of results to delete from DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Delete the search results? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># delete records in reverse order</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_rec</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Commit at every 200th removal</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.delete_rec_all"><a class="viewcode-back" href="../buku.html#buku.BukuDb.delete_rec_all">[docs]</a>    <span class="k">def</span> <span class="nf">delete_rec_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removes all records in the Bookmarks table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        delay_commit : bool, optional</span>
<span class="sd">            True if record should not be committed to the DB,</span>
<span class="sd">            leaving commit responsibility to caller. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM bookmarks&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delay_commit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;delete_rec_all(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BukuDb.cleardb"><a class="viewcode-back" href="../buku.html#buku.BukuDb.cleardb">[docs]</a>    <span class="k">def</span> <span class="nf">cleardb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drops the bookmark table if it exists.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="s1">&#39;Remove ALL bookmarks? (y/n): &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No bookmarks deleted&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_rec_all</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;VACUUM&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All bookmarks deleted&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BukuDb.print_rec"><a class="viewcode-back" href="../buku.html#buku.BukuDb.print_rec">[docs]</a>    <span class="k">def</span> <span class="nf">print_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">low</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">is_range</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Print bookmark details at index or all bookmarks if index is 0.</span>

<span class="sd">        A negative index behaves like tail, if title is blank show &quot;Untitled&quot;.</span>

<span class="sd">        Empty database check will run when `index` &lt; 0 and `is_range` is False.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        index : int, optional</span>
<span class="sd">            DB index of record to print. 0 prints all records.</span>
<span class="sd">        low : int, optional</span>
<span class="sd">            Actual lower index of range.</span>
<span class="sd">        high : int, optional</span>
<span class="sd">            Actual higher index of range.</span>
<span class="sd">        is_range : bool, optional</span>
<span class="sd">            A range is passed using low and high arguments.</span>
<span class="sd">            An index is ignored if is_range is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import buku</span>
<span class="sd">        &gt;&gt;&gt; from tempfile import NamedTemporaryFile</span>
<span class="sd">        &gt;&gt;&gt; edb = buku.BukuDb(dbfile=NamedTemporaryFile().name)  # empty database</span>
<span class="sd">        &gt;&gt;&gt; edb.print_rec()</span>
<span class="sd">        True</span>

<span class="sd">        Print negative index on empty database will log error and return False</span>

<span class="sd">        &gt;&gt;&gt; edb.print_rec(-3)</span>
<span class="sd">        False</span>

<span class="sd">        print non empty database with default argument.</span>

<span class="sd">        &gt;&gt;&gt; sdb = buku.BukuDb(dbfile=NamedTemporaryFile().name)  # single record database</span>
<span class="sd">        &gt;&gt;&gt; sdb.add_rec(&#39;https://example.com&#39;)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; assert sdb.print_rec()</span>
<span class="sd">        1. Example Domain</span>
<span class="sd">           &gt; https://example.com</span>
<span class="sd">        &lt;BLANKLINE&gt;</span>

<span class="sd">        Negative number on `high` and `low` paramaters when is_range is True</span>
<span class="sd">        will log error and return False</span>

<span class="sd">        &gt;&gt;&gt; sdb.print_rec(low=-1, high=-1, is_range=True)</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; edb.print_rec(low=-1, high=-1, is_range=True)</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_range</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Show the last n records</span>
            <span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_max_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Empty database&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">_id</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">index</span> <span class="k">else</span> <span class="n">_id</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">high</span> <span class="o">=</span> <span class="n">_id</span>
            <span class="n">is_range</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">is_range</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Negative range boundary&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If range starts from 0 print all records</span>
                <span class="k">if</span> <span class="n">low</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * from bookmarks&#39;</span>
                    <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * from bookmarks where id BETWEEN ? AND ?&#39;</span>
                    <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Index out of range&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Show record at index</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM bookmarks WHERE id = ? LIMIT 1&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                    <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">print_rec_with_filter</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
                <span class="n">write_string_to_file</span><span class="p">(</span><span class="n">format_json</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_json_safe</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Show all entries</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM bookmarks&#39;</span><span class="p">)</span>
            <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;0 records&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">print_rec_with_filter</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">write_string_to_file</span><span class="p">(</span><span class="n">format_json</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">print_json_safe</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field_filter</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.get_tag_all"><a class="viewcode-back" href="../buku.html#buku.BukuDb.get_tag_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_tag_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get list of tags in DB.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (list of unique tags sorted alphabetically,</span>
<span class="sd">             dictionary of {tag: usage_count}).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unique_tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT tags, COUNT(tags) FROM bookmarks GROUP BY tags&#39;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">):</span>
            <span class="n">tagset</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tagset</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">tags</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tag</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dic</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tags</span><span class="p">,</span> <span class="n">dic</span>

        <span class="k">if</span> <span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">unique_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unique_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">unique_tags</span><span class="p">,</span> <span class="n">dic</span></div>

<div class="viewcode-block" id="BukuDb.suggest_similar_tag"><a class="viewcode-back" href="../buku.html#buku.BukuDb.suggest_similar_tag">[docs]</a>    <span class="k">def</span> <span class="nf">suggest_similar_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tagstr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show list of tags those go together in DB.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tagstr : str</span>
<span class="sd">            Original tag string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            DELIM separated string of tags.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tagstr</span>

        <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT tags FROM bookmarks WHERE tags LIKE ?&#39;</span>
        <span class="n">tagset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">,))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="c1"># update tagset with unique tags in row</span>
                <span class="n">tagset</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">))</span>

        <span class="c1"># remove user supplied tags from tagset</span>
        <span class="n">tagset</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tagset</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tagstr</span>

        <span class="n">unique_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tagset</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;similar tags:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_tags</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unique_tags</span><span class="p">[</span><span class="n">count</span><span class="p">]))</span>

        <span class="n">selected_tags</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">select: &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">tagstr</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tagstr</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">selected_tags</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delim_wrap</span><span class="p">(</span><span class="n">unique_tags</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.replace_tag"><a class="viewcode-back" href="../buku.html#buku.BukuDb.replace_tag">[docs]</a>    <span class="k">def</span> <span class="nf">replace_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Replace original tag by new tags in all records.</span>

<span class="sd">        Remove original tag if new tag is empty.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        orig : str</span>
<span class="sd">            Original tag.</span>
<span class="sd">        new : list</span>
<span class="sd">            Replacement tags.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">newtags</span> <span class="o">=</span> <span class="n">DELIM</span>

        <span class="n">orig</span> <span class="o">=</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">orig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newtags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orig</span> <span class="o">==</span> <span class="n">newtags</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tags are same.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Remove original tag from DB if new tagset reduces to delimiter</span>
        <span class="k">if</span> <span class="n">newtags</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">orig</span><span class="p">)</span>

        <span class="c1"># Update bookmarks with original tag</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT id, tags FROM bookmarks WHERE tags LIKE ?&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="n">orig</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">,))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="n">newtags</span><span class="p">)</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Index </span><span class="si">%d</span><span class="s1"> updated&#39;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.get_tagstr_from_taglist"><a class="viewcode-back" href="../buku.html#buku.BukuDb.get_tagstr_from_taglist">[docs]</a>    <span class="k">def</span> <span class="nf">get_tagstr_from_taglist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_list</span><span class="p">,</span> <span class="n">taglist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a string of delimiter-separated (and enclosed) string</span>
<span class="sd">        of tags from a dictionary of tags by matching ids.</span>

<span class="sd">        The inputs are the outputs from BukuDb.get_tag_all().</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id_list : list</span>
<span class="sd">            List of ids.</span>
<span class="sd">        taglist : list</span>
<span class="sd">            List of tags.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Delimiter separated and enclosed list of tags.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>

        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">+=</span> <span class="n">taglist</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">DELIM</span>
            <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">tags</span> <span class="o">+=</span> <span class="n">taglist</span><span class="p">[</span><span class="n">_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">DELIM</span>

        <span class="k">return</span> <span class="n">tags</span></div>

<div class="viewcode-block" id="BukuDb.set_tag"><a class="viewcode-back" href="../buku.html#buku.BukuDb.set_tag">[docs]</a>    <span class="k">def</span> <span class="nf">set_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdstr</span><span class="p">,</span> <span class="n">taglist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append, overwrite, remove tags using the symbols &gt;&gt;, &gt; and &lt;&lt; respectively.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cmdstr : str</span>
<span class="sd">            Command pattern.</span>
<span class="sd">        taglist : list</span>
<span class="sd">            List of tags.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Number of indices updated on success, -1 on failure, -2 on no symbol found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cmdstr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">taglist</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0: invalid, 1: append, 2: overwrite, 3: remove</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">2</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tagstr_from_taglist</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">taglist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="n">DELIM</span> <span class="ow">and</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">flag</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">update_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_id_list</span> <span class="o">=</span> <span class="n">cmdstr</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">db_id_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_tag_at_index</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                            <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="nb">id</span><span class="p">,))</span>
                        <span class="n">update_count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_tag_at_index</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                                <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">_id</span><span class="p">,))</span>
                            <span class="n">update_count</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">rowcount</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                                <span class="n">update_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">update_count</span></div>

<div class="viewcode-block" id="BukuDb.browse_by_index"><a class="viewcode-back" href="../buku.html#buku.BukuDb.browse_by_index">[docs]</a>    <span class="k">def</span> <span class="nf">browse_by_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_range</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open URL at index or range of indices in browser.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index to browse. 0 opens a random bookmark.</span>
<span class="sd">        low : int</span>
<span class="sd">            Actual lower index of range.</span>
<span class="sd">        high : int</span>
<span class="sd">            Higher index of range.</span>
<span class="sd">        is_range : bool</span>
<span class="sd">            A range is passed using low and high arguments.</span>
<span class="sd">            If True, index is ignored. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">is_range</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">high</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Negative range boundary&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If range starts from 0 throw an error</span>
                <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span>

                <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT URL from bookmarks where id BETWEEN ? AND ?&#39;</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)):</span>
                    <span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Index out of range&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Invalid index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT id from bookmarks ORDER BY RANDOM() LIMIT 1&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

            <span class="c1"># Return if no entries in DB</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No bookmarks added yet ...&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">index</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;Opening random index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;SELECT URL FROM bookmarks WHERE id = ? LIMIT 1&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,)):</span>
                <span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BukuDb.exportdb"><a class="viewcode-back" href="../buku.html#buku.BukuDb.exportdb">[docs]</a>    <span class="k">def</span> <span class="nf">exportdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resultset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">BookmarkVar</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Export DB bookmarks to file.</span>
<span class="sd">        Exports full DB, if resultset is None</span>

<span class="sd">        If destination file name ends with &#39;.db&#39;, bookmarks are</span>
<span class="sd">        exported to a buku database file.</span>
<span class="sd">        If destination file name ends with &#39;.md&#39;, bookmarks are</span>
<span class="sd">        exported to a Markdown file.</span>
<span class="sd">        If destination file name ends with &#39;.org&#39; bookmarks are</span>
<span class="sd">        exported to a org file.</span>
<span class="sd">        Otherwise, bookmarks are exported to a Firefox bookmarks.html</span>
<span class="sd">        formatted file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Path to export destination file.</span>
<span class="sd">        resultset : list of tuples</span>
<span class="sd">            List of results to export.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rec_all</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No records found&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39; exists. Overwrite? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.db&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.db&#39;</span><span class="p">):</span>
            <span class="n">outdb</span> <span class="o">=</span> <span class="n">BukuDb</span><span class="p">(</span><span class="n">dbfile</span><span class="o">=</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">qry</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO bookmarks(URL, metadata, tags, desc, flags) VALUES (?, ?, ?, ?, ?)&#39;</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="n">outdb</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">qry</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">outdb</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">outdb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exported&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfp</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict</span>
            <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">convert_bookmark_set</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="s1">&#39;markdown&#39;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.org&#39;</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">convert_bookmark_set</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="s1">&#39;org&#39;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">convert_bookmark_set</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
                <span class="n">outfp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exported&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BukuDb.traverse_bm_folder"><a class="viewcode-back" href="../buku.html#buku.BukuDb.traverse_bm_folder">[docs]</a>    <span class="k">def</span> <span class="nf">traverse_bm_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sublist</span><span class="p">,</span> <span class="n">unique_tag</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Traverse bookmark folders recursively and find bookmarks.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sublist : list</span>
<span class="sd">            List of child entries in bookmark folder.</span>
<span class="sd">        unique_tag : str</span>
<span class="sd">            Timestamp tag in YYYYMonDD format.</span>
<span class="sd">        folder_name : str</span>
<span class="sd">            Name of the parent folder.</span>
<span class="sd">        add_parent_folder_as_tag : bool</span>
<span class="sd">            True if bookmark parent folders should be added as tags else False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            Bookmark record data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;folder&#39;</span><span class="p">:</span>
                <span class="n">next_folder_name</span> <span class="o">=</span> <span class="n">folder_name</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse_bm_folder</span><span class="p">(</span>
                        <span class="n">item</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">],</span>
                        <span class="n">unique_tag</span><span class="p">,</span>
                        <span class="n">next_folder_name</span><span class="p">,</span>
                        <span class="n">add_parent_folder_as_tag</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">i</span>
            <span class="k">elif</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]):</span>
                        <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">add_parent_folder_as_tag</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">+=</span> <span class="n">folder_name</span>
                <span class="k">if</span> <span class="n">unique_tag</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">+=</span> <span class="n">DELIM</span> <span class="o">+</span> <span class="n">unique_tag</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">]),</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.load_chrome_database"><a class="viewcode-back" href="../buku.html#buku.BukuDb.load_chrome_database">[docs]</a>    <span class="k">def</span> <span class="nf">load_chrome_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">unique_tag</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open Chrome Bookmarks JSON file and import data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to Google Chrome bookmarks file.</span>
<span class="sd">        unique_tag : str</span>
<span class="sd">            Timestamp tag in YYYYMonDD format.</span>
<span class="sd">        add_parent_folder_as_tag : bool</span>
<span class="sd">            True if bookmark parent folders should be added as tags else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

        <span class="n">roots</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;roots&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="c1"># Needed to skip &#39;sync_transaction_version&#39; key from roots</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">roots</span><span class="p">[</span><span class="n">entry</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traverse_bm_folder</span><span class="p">(</span>
                    <span class="n">roots</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="s1">&#39;children&#39;</span><span class="p">],</span>
                    <span class="n">unique_tag</span><span class="p">,</span>
                    <span class="n">roots</span><span class="p">[</span><span class="n">entry</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                    <span class="n">add_parent_folder_as_tag</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.load_firefox_database"><a class="viewcode-back" href="../buku.html#buku.BukuDb.load_firefox_database">[docs]</a>    <span class="k">def</span> <span class="nf">load_firefox_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">unique_tag</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect to Firefox sqlite db and import bookmarks into BukuDb.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to Firefox bookmarks sqlite database.</span>
<span class="sd">        unique_tag : str</span>
<span class="sd">            Timestamp tag in YYYYMonDD format.</span>
<span class="sd">        add_parent_folder_as_tag : bool</span>
<span class="sd">            True if bookmark parent folders should be added as tags else False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Connect to input DB</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;file:</span><span class="si">%s</span><span class="s1">?mode=ro&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT DISTINCT fk, parent, title FROM moz_bookmarks WHERE type=1&#39;</span><span class="p">)</span>
        <span class="c1"># get id&#39;s and remove duplicates</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="c1"># get the url</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT url FROM moz_places where id=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># get tags</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT parent FROM moz_bookmarks WHERE &#39;</span>
                              <span class="s1">&#39;fk=</span><span class="si">{}</span><span class="s1"> AND title IS NULL&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">bm_tag_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">tid</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span> <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>

            <span class="n">bookmark_tags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bm_tag_id</span> <span class="ow">in</span> <span class="n">bm_tag_ids</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT title FROM moz_bookmarks WHERE id=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bm_tag_id</span><span class="p">))</span>
                <span class="n">bookmark_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">add_parent_folder_as_tag</span><span class="p">:</span>
                <span class="c1"># add folder name</span>
                <span class="n">parent_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">while</span> <span class="n">parent_id</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT title,parent FROM moz_bookmarks &#39;</span>
                                      <span class="s1">&#39;WHERE id=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent_id</span><span class="p">))</span>
                    <span class="n">parent</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                        <span class="n">title</span><span class="p">,</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="n">parent</span>
                        <span class="n">bookmark_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">unique_tag</span><span class="p">:</span>
                <span class="c1"># add timestamp tag</span>
                <span class="n">bookmark_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_tag</span><span class="p">)</span>

            <span class="n">formatted_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">DELIM</span> <span class="o">+</span> <span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">bookmark_tags</span><span class="p">]</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">formatted_tags</span><span class="p">)</span>

            <span class="c1"># get the title</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.auto_import_from_browser"><a class="viewcode-back" href="../buku.html#buku.BukuDb.auto_import_from_browser">[docs]</a>    <span class="k">def</span> <span class="nf">auto_import_from_browser</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import bookmarks from a browser default database file.</span>

<span class="sd">        Supports Firefox and Google Chrome.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ff_bm_db_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;freebsd&#39;</span><span class="p">,</span> <span class="s1">&#39;openbsd&#39;</span><span class="p">)):</span>
            <span class="n">gc_bm_db_path</span> <span class="o">=</span> <span class="s1">&#39;~/.config/google-chrome/Default/Bookmarks&#39;</span>
            <span class="n">cb_bm_db_path</span> <span class="o">=</span> <span class="s1">&#39;~/.config/chromium/Default/Bookmarks&#39;</span>

            <span class="n">default_ff_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/.mozilla/firefox&#39;</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">get_firefox_profile_name</span><span class="p">(</span><span class="n">default_ff_folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
                <span class="n">ff_bm_db_path</span> <span class="o">=</span> <span class="s1">&#39;~/.mozilla/firefox/</span><span class="si">{}</span><span class="s1">/places.sqlite&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
            <span class="n">gc_bm_db_path</span> <span class="o">=</span> <span class="s1">&#39;~/Library/Application Support/Google/Chrome/Default/Bookmarks&#39;</span>
            <span class="n">cb_bm_db_path</span> <span class="o">=</span> <span class="s1">&#39;~/Library/Application Support/Chromium/Default/Bookmarks&#39;</span>

            <span class="n">default_ff_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/Library/Application Support/Firefox&#39;</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">get_firefox_profile_name</span><span class="p">(</span><span class="n">default_ff_folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
                <span class="n">ff_bm_db_path</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;~/Library/Application Support/Firefox/&#39;</span>
                                 <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/places.sqlite&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()</span>
            <span class="n">gc_bm_db_path</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;C:/Users/</span><span class="si">{}</span><span class="s1">/AppData/Local/Google/Chrome/User Data/&#39;</span>
                             <span class="s1">&#39;Default/Bookmarks&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
            <span class="n">cb_bm_db_path</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;C:/Users/</span><span class="si">{}</span><span class="s1">/AppData/Local/Chromium/User Data/&#39;</span>
                             <span class="s1">&#39;Default/Bookmarks&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>

            <span class="n">default_ff_folder</span> <span class="o">=</span> <span class="s1">&#39;C:/Users/</span><span class="si">{}</span><span class="s1">/AppData/Roaming/Mozilla/Firefox/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">get_firefox_profile_name</span><span class="p">(</span><span class="n">default_ff_folder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
                <span class="n">ff_bm_db_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_ff_folder</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/places.sqlite&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;buku does not support </span><span class="si">{}</span><span class="s1"> yet&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Generate auto-tag (YYYYMonDD)? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">newtag</span> <span class="o">=</span> <span class="n">gen_auto_tag</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newtag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Add parent folder names as tags? (y/n): &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
        <span class="n">add_parent_folder_as_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Import bookmarks from google chrome? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">bookmarks_database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">gc_bm_db_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bookmarks_database</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_chrome_database</span><span class="p">(</span><span class="n">bookmarks_database</span><span class="p">,</span> <span class="n">newtag</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not import bookmarks from google-chrome&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Import bookmarks from chromium? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">bookmarks_database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">cb_bm_db_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bookmarks_database</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_chrome_database</span><span class="p">(</span><span class="n">bookmarks_database</span><span class="p">,</span> <span class="n">newtag</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not import bookmarks from chromium&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chatty</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Import bookmarks from Firefox? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">bookmarks_database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">ff_bm_db_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bookmarks_database</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_firefox_database</span><span class="p">(</span><span class="n">bookmarks_database</span><span class="p">,</span> <span class="n">newtag</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not import bookmarks from Firefox.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">newtag</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Auto-generated tag: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">newtag</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.importdb"><a class="viewcode-back" href="../buku.html#buku.BukuDb.importdb">[docs]</a>    <span class="k">def</span> <span class="nf">importdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">tacit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Import bookmarks from a HTML or a Markdown file.</span>

<span class="sd">        Supports Firefox, Google Chrome, and IE exported HTML bookmarks.</span>
<span class="sd">        Supports Markdown files with extension &#39;.md, .org&#39;.</span>
<span class="sd">        Supports importing bookmarks from another buku database file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Path to file to import.</span>
<span class="sd">        tacit : bool, optional</span>
<span class="sd">            If True, no questions asked and folder names are automatically</span>
<span class="sd">            imported as tags from bookmarks HTML.</span>
<span class="sd">            If True, automatic timestamp tag is NOT added.</span>
<span class="sd">            Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.db&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mergedb</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="n">newtag</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">append_tags_resp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Generate auto-tag (YYYYMonDD)? (y/n): &#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">newtag</span> <span class="o">=</span> <span class="n">gen_auto_tag</span><span class="p">()</span>
            <span class="n">append_tags_resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Append tags when bookmark exist? (y/n): &#39;</span><span class="p">)</span>

        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.md&#39;</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">import_md</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span> <span class="n">newtag</span><span class="o">=</span><span class="n">newtag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;org&#39;</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">import_org</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span> <span class="n">newtag</span><span class="o">=</span><span class="n">newtag</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Add parent folder names as tags? (y/n): &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
            <span class="n">add_bookmark_folder_as_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">datafile</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>

                <span class="n">items</span> <span class="o">=</span> <span class="n">import_firefox_json</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">add_bookmark_folder_as_tag</span><span class="p">,</span> <span class="n">newtag</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s2">&quot;ff_json: JSON Decode Error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">:</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">infp</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Beautiful Soup not found&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="n">add_parent_folder_as_tag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">use_nested_folder_structure</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Add bookmark&#39;s parent folder as tag?</span>
<span class="s2">y: add single, direct parent folder</span>
<span class="s2">a: add all parent folders of the bookmark</span>
<span class="s2">n: don&#39;t add parent folder as tag</span>
<span class="s2">(y/a/[n]): &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>

            <span class="k">if</span> <span class="n">resp</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">):</span>
                <span class="n">add_parent_folder_as_tag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">resp</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
                    <span class="n">use_nested_folder_structure</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">items</span> <span class="o">=</span> <span class="n">import_html</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">,</span> <span class="n">newtag</span><span class="p">,</span> <span class="n">use_nested_folder_structure</span><span class="p">)</span>
            <span class="n">infp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">add_rec_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_rec_res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">append_tags_resp</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">rec_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rec_id</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append_tag_at_index</span><span class="p">(</span><span class="n">rec_id</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">newtag</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Auto-generated tag: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">newtag</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.mergedb"><a class="viewcode-back" href="../buku.html#buku.BukuDb.mergedb">[docs]</a>    <span class="k">def</span> <span class="nf">mergedb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge bookmarks from another buku database file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            Path to DB file to merge.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True on success, False on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Connect to input DB</span>
            <span class="n">indb_conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;file:</span><span class="si">%s</span><span class="s1">?mode=ro&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">indb_cur</span> <span class="o">=</span> <span class="n">indb_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">indb_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT * FROM bookmarks&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">resultset</span> <span class="o">=</span> <span class="n">indb_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">indb_cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">indb_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BukuDb.tnyfy_url"><a class="viewcode-back" href="../buku.html#buku.BukuDb.tnyfy_url">[docs]</a>    <span class="k">def</span> <span class="nf">tnyfy_url</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">shorten</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Shorten a URL using Google URL shortener.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int, optional (if URL is provided)</span>
<span class="sd">            DB index of the bookmark with the URL to shorten. Default is 0.</span>
<span class="sd">        url : str, optional (if index is provided)</span>
<span class="sd">            URL to shorten.</span>
<span class="sd">        shorten : bool, optional</span>
<span class="sd">            True to shorten, False to expand. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Shortened url on success, None on failure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">global</span> <span class="n">MYPROXY</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Either a valid DB index or URL required&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT url FROM bookmarks WHERE id = ? LIMIT 1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span><span class="p">,))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">url</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote_plus</span> <span class="k">as</span> <span class="n">qp</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">urlbase</span> <span class="o">=</span> <span class="s1">&#39;https://tny.im/yourls-api.php?action=&#39;</span>
        <span class="k">if</span> <span class="n">shorten</span><span class="p">:</span>
            <span class="n">_u</span> <span class="o">=</span> <span class="n">urlbase</span> <span class="o">+</span> <span class="s1">&#39;shorturl&amp;format=simple&amp;url=&#39;</span> <span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_u</span> <span class="o">=</span> <span class="n">urlbase</span> <span class="o">+</span> <span class="s1">&#39;expand&amp;format=simple&amp;shorturl=&#39;</span> <span class="o">+</span> <span class="n">qp</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">MYPROXY</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gen_headers</span><span class="p">()</span>

        <span class="n">ca_certs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUKU_CA_CERTS&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">CA_CERTS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">MYPROXY</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">ProxyManager</span><span class="p">(</span>
                <span class="n">MYPROXY</span><span class="p">,</span>
                <span class="n">num_pools</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">MYHEADERS</span><span class="p">,</span>
                <span class="n">cert_reqs</span><span class="o">=</span><span class="s1">&#39;CERT_REQUIRED&#39;</span><span class="p">,</span>
                <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">PoolManager</span><span class="p">(</span><span class="n">num_pools</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">},</span>
                                          <span class="n">cert_reqs</span><span class="o">=</span><span class="s1">&#39;CERT_REQUIRED&#39;</span><span class="p">,</span>
                                          <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                <span class="n">_u</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BukuDb.browse_cached_url"><a class="viewcode-back" href="../buku.html#buku.BukuDb.browse_cached_url">[docs]</a>    <span class="k">def</span> <span class="nf">browse_cached_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open URL at index or URL.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arg : str</span>
<span class="sd">            Index or url to browse</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Wayback Machine URL, None if not cached</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">quote_plus</span>

        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rec_by_id</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">arg</span>

        <span class="c1"># Try fetching cached page from Wayback Machine</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="s1">&#39;https://archive.org/wayback/available?url=&#39;</span> <span class="o">+</span> <span class="n">quote_plus</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">get_PoolManager</span><span class="p">()</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">api_url</span><span class="p">)</span>
        <span class="n">respobj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">respobj</span><span class="p">[</span><span class="s1">&#39;archived_snapshots&#39;</span><span class="p">])</span> <span class="ow">and</span>
                    <span class="n">respobj</span><span class="p">[</span><span class="s1">&#39;archived_snapshots&#39;</span><span class="p">][</span><span class="s1">&#39;closest&#39;</span><span class="p">][</span><span class="s1">&#39;available&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">respobj</span><span class="p">[</span><span class="s1">&#39;archived_snapshots&#39;</span><span class="p">][</span><span class="s1">&#39;closest&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Uncached&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BukuDb.fixtags"><a class="viewcode-back" href="../buku.html#buku.BukuDb.fixtags">[docs]</a>    <span class="k">def</span> <span class="nf">fixtags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Undocumented API to fix tags set in earlier versions.</span>

<span class="sd">        Functionalities:</span>

<span class="sd">        1. Remove duplicate tags</span>
<span class="sd">        2. Sort tags</span>
<span class="sd">        3. Use lower case to store tags</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">to_commit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, tags FROM bookmarks ORDER BY id ASC&#39;</span><span class="p">)</span>
        <span class="n">resultset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE bookmarks SET tags = ? WHERE id = ?&#39;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">oldtags</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">oldtags</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">oldtags</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="n">oldtags</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
            <span class="n">to_commit</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">to_commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="BukuDb.close"><a class="viewcode-back" href="../buku.html#buku.BukuDb.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close a DB connection.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ignore errors here, we&#39;re closing down</span>
                <span class="k">pass</span></div>

<div class="viewcode-block" id="BukuDb.close_quit"><a class="viewcode-back" href="../buku.html#buku.BukuDb.close_quit">[docs]</a>    <span class="k">def</span> <span class="nf">close_quit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exitval</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close a DB connection and exit.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exitval : int, optional</span>
<span class="sd">            Program exit value.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># ignore errors here, we&#39;re closing down</span>
                <span class="k">pass</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exitval</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ExtendedArgumentParser"><a class="viewcode-back" href="../buku.html#buku.ExtendedArgumentParser">[docs]</a><span class="k">class</span> <span class="nc">ExtendedArgumentParser</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extend classic argument parser.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ExtendedArgumentParser.program_info"><a class="viewcode-back" href="../buku.html#buku.ExtendedArgumentParser.program_info">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">program_info</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print program info.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : file, optional</span>
<span class="sd">            File to write program info to. Default is sys.stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">and</span> <span class="n">file</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>

        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">SYMBOLS:</span>
<span class="s1">      &gt;                    url</span>
<span class="s1">      +                    comment</span>
<span class="s1">      #                    tags</span>

<span class="s1">Version </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">Copyright Â© 2015-2022 </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">License: </span><span class="si">%s</span><span class="s1"></span>
<span class="s1">Webpage: https://github.com/jarun/buku</span>
<span class="s1">&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">__version__</span><span class="p">,</span> <span class="n">__author__</span><span class="p">,</span> <span class="n">__license__</span><span class="p">))</span></div>

<div class="viewcode-block" id="ExtendedArgumentParser.prompt_help"><a class="viewcode-back" href="../buku.html#buku.ExtendedArgumentParser.prompt_help">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">prompt_help</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print prompt help.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : file, optional</span>
<span class="sd">            File to write program info to. Default is sys.stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">PROMPT KEYS:</span>
<span class="s1">    1-N                    browse search result indices and/or ranges</span>
<span class="s1">    O [id|range [...]]     open search results/indices in GUI browser</span>
<span class="s1">                           toggle try GUI browser if no arguments</span>
<span class="s1">    a                      open all results in browser</span>
<span class="s1">    s keyword [...]        search for records with ANY keyword</span>
<span class="s1">    S keyword [...]        search for records with ALL keywords</span>
<span class="s1">    d                      match substrings (&#39;pen&#39; matches &#39;opened&#39;)</span>
<span class="s1">    r expression           run a regex search</span>
<span class="s1">    t [tag, ...]           search by tags; show taglist, if no args</span>
<span class="s1">    g taglist id|range [...] [&gt;&gt;|&gt;|&lt;&lt;] [record id|range ...]</span>
<span class="s1">                           append, set, remove (all or specific) tags</span>
<span class="s1">                           search by taglist id(s) if records are omitted</span>
<span class="s1">    n                      show next page of search results</span>
<span class="s1">    o id|range [...]       browse bookmarks by indices and/or ranges</span>
<span class="s1">    p id|range [...]       print bookmarks by indices and/or ranges</span>
<span class="s1">    w [editor|id]          edit and add or update a bookmark</span>
<span class="s1">    c id                   copy url at search result index to clipboard</span>
<span class="s1">    ?                      show this help</span>
<span class="s1">    q, ^D, double Enter    exit buku</span>

<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ExtendedArgumentParser.is_colorstr"><a class="viewcode-back" href="../buku.html#buku.ExtendedArgumentParser.is_colorstr">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_colorstr</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a string is a valid color string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arg : str</span>
<span class="sd">            Color string to validate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Same color string that was passed as an argument.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ArgumentTypeError</span>
<span class="sd">            If the arg is not a valid color string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">COLORMAP</span>
        <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid color string&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">return</span> <span class="n">arg</span></div>

    <span class="c1"># Help</span>
<div class="viewcode-block" id="ExtendedArgumentParser.print_help"><a class="viewcode-back" href="../buku.html#buku.ExtendedArgumentParser.print_help">[docs]</a>    <span class="k">def</span> <span class="nf">print_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print help prompt.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : file, optional</span>
<span class="sd">            File to write program info to. Default is sys.stdout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">print_help</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program_info</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div></div>


<span class="c1"># ----------------</span>
<span class="c1"># Helper functions</span>
<span class="c1"># ----------------</span>


<span class="n">ConverterResult</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span><span class="s1">&#39;ConverterResult&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span> <span class="k">if</span> <span class="n">TypedDict</span> <span class="k">else</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>


<div class="viewcode-block" id="convert_tags_to_org_mode_tags"><a class="viewcode-back" href="../buku.html#buku.convert_tags_to_org_mode_tags">[docs]</a><span class="k">def</span> <span class="nf">convert_tags_to_org_mode_tags</span><span class="p">(</span><span class="n">tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;convert buku tags to org-mode compatible tags.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
        <span class="n">buku_tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">buku_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9_@]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">buku_tags</span><span class="p">]</span>
        <span class="n">buku_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">buku_tags</span><span class="p">]</span>
        <span class="n">buku_tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">buku_tags</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">buku_tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39; :</span><span class="si">{}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buku_tags</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="convert_bookmark_set"><a class="viewcode-back" href="../buku.html#buku.convert_bookmark_set">[docs]</a><span class="k">def</span> <span class="nf">convert_bookmark_set</span><span class="p">(</span>
        <span class="n">bookmark_set</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BookmarkVar</span><span class="p">],</span>
        <span class="n">export_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConverterResult</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
    <span class="sd">&quot;&quot;&quot;Convert list of bookmark set into multiple data format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        bookmark_set: bookmark set</span>
<span class="sd">        export type: one of supported type: markdown, html, org</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        converted data and count of converted bookmark set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">export_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;markdown&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;org&#39;</span><span class="p">]</span>
    <span class="c1">#  compatibility</span>
    <span class="n">resultset</span> <span class="o">=</span> <span class="n">bookmark_set</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">export_type</span> <span class="o">==</span> <span class="s1">&#39;markdown&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;- [Untitled](&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;- [&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;](&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; &lt;!-- TAGS: </span><span class="si">{}</span><span class="s1"> --&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">export_type</span> <span class="o">==</span> <span class="s1">&#39;org&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;* [[</span><span class="si">{}</span><span class="s1">][Untitled]]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;* [[</span><span class="si">{}</span><span class="s1">][</span><span class="si">{}</span><span class="s1">]]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="n">convert_tags_to_org_mode_tags</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">export_type</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;&lt;!DOCTYPE NETSCAPE-Bookmark-file-1&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;&lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=UTF-8&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;&lt;TITLE&gt;Bookmarks&lt;/TITLE&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;&lt;H1&gt;Bookmarks&lt;/H1&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;&lt;DL&gt;&lt;p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;    &lt;DT&gt;&lt;H3 ADD_DATE=&quot;</span><span class="si">{0}</span><span class="s1">&quot; LAST_MODIFIED=&quot;</span><span class="si">{0}</span><span class="s1">&quot; &#39;</span>
            <span class="s1">&#39;PERSONAL_TOOLBAR_FOLDER=&quot;true&quot;&gt;buku bookmarks&lt;/H3&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;    &lt;DL&gt;&lt;p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;        &lt;DT&gt;&lt;A HREF=&quot;</span><span class="si">%s</span><span class="s1">&quot; ADD_DATE=&quot;</span><span class="si">%s</span><span class="s1">&quot; LAST_MODIFIED=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; TAGS=&quot;&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;&gt;</span><span class="si">{}</span><span class="s1">&lt;/A&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;        &lt;DD&gt;&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;    &lt;/DL&gt;&lt;p&gt;</span><span class="se">\n</span><span class="s1">&lt;/DL&gt;&lt;p&gt;&#39;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">out</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_firefox_profile_name"><a class="viewcode-back" href="../buku.html#buku.get_firefox_profile_name">[docs]</a><span class="k">def</span> <span class="nf">get_firefox_profile_name</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List folder and detect default Firefox profile name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    profile : str</span>
<span class="sd">        Firefox profile name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span><span class="p">,</span> <span class="n">NoOptionError</span>

    <span class="n">profile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;profiles.ini&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">profile_path</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">profile_path</span><span class="p">)</span>

        <span class="n">install_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">section</span> <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span> <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Install&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">install_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">profile_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">profile_path</span>
            <span class="k">except</span> <span class="n">NoOptionError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">profiles_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">section</span> <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span> <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Profile&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">profiles_names</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">profiles_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If profile is default</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">):</span>
                    <span class="n">profile_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">profile_path</span>
            <span class="k">except</span> <span class="n">NoOptionError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># alternative way to detect default profile</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                    <span class="n">profile_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">profile_path</span>
            <span class="k">except</span> <span class="n">NoOptionError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># There is no default profile</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;get_firefox_profile_name(): </span><span class="si">{}</span><span class="s1"> does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="walk"><a class="viewcode-back" href="../buku.html#buku.walk">[docs]</a><span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursively iterate over JSON.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    root : JSON element</span>
<span class="sd">        Base node of the JSON data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">walk</span><span class="p">(</span><span class="n">element</span><span class="p">)</span></div>


<div class="viewcode-block" id="import_md"><a class="viewcode-back" href="../buku.html#buku.import_md">[docs]</a><span class="k">def</span> <span class="nf">import_md</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">newtag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Parse bookmark Markdown file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        Path to Markdown file.</span>
<span class="sd">    newtag : str, optional</span>
<span class="sd">        New tag for bookmarks in Markdown file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Parsed result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infp</span><span class="p">:</span>
            <span class="c1"># Supported Markdown format: [title](url)</span>
            <span class="c1"># Find position of title end, url start delimiter combo</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;](&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Find title start delimiter</span>
                <span class="n">title_start_delim</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>
                <span class="c1"># Reverse find the url end delimiter</span>
                <span class="n">url_end_delim</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">title_start_delim</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">url_end_delim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Parse title</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">title_start_delim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">index</span><span class="p">]</span>
                    <span class="c1"># Parse url</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">url_end_delim</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># Find tag start delimiter</span>
                    <span class="n">tag_start_delim</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&lt;!-- TAGS: &#39;</span><span class="p">)</span>
                    <span class="c1"># Reverse find tag end delimiter</span>
                    <span class="n">tag_end_delim</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39; --&gt;&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_start_delim</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">tag_end_delim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">newtag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tags</span> <span class="o">=</span> <span class="n">newtag</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">tag_start_delim</span> <span class="o">+</span> <span class="mi">11</span><span class="p">:</span><span class="n">tag_end_delim</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tags</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">tag_start_delim</span> <span class="o">+</span> <span class="mi">11</span><span class="p">:</span><span class="n">tag_end_delim</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tags</span> <span class="o">=</span> <span class="n">newtag</span>

                    <span class="n">parse_tags</span><span class="p">([</span><span class="n">tags</span><span class="p">])</span>

                    <span class="k">yield</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tags</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="import_org"><a class="viewcode-back" href="../buku.html#buku.import_org">[docs]</a><span class="k">def</span> <span class="nf">import_org</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">newtag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Parse bookmark org file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filepath : str</span>
<span class="sd">        Path to org file.</span>
<span class="sd">    newtag : str, optional</span>
<span class="sd">        New tag for bookmarks in org file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Parsed result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_org_tags</span><span class="p">(</span><span class="n">tag_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts tags from Org</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tag_string: str</span>
<span class="sd">             string of tags in Org-format</span>

<span class="sd">        Syntax: Org splits tags with colons. If colons are part of a buku-tag, this is indicated by using</span>
<span class="sd">                multiple colons in org. If a buku-tag starts or ends with a colon, this is indicated by a</span>
<span class="sd">                preceding or trailing whitespace</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            List of tags</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag_list_raw</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?&lt;!\:)\:&#39;</span><span class="p">,</span> <span class="n">tag_string</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">tag_list_cleaned</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tag_list_raw</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tag_list_raw</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
                    <span class="n">tag_list_cleaned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_item</span> <span class="o">=</span> <span class="n">tag_list_cleaned</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tag</span>
                    <span class="k">del</span> <span class="n">tag_list_cleaned</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">tag_list_cleaned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_item</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
                <span class="n">tag_list_cleaned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">tag_list_cleaned</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infp</span><span class="p">:</span>
        <span class="c1"># Supported Markdown format: * [[url][title]] :tags:</span>
        <span class="c1"># Find position of url end, title start delimiter combo</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infp</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;][&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Find url start delimiter</span>
                <span class="n">url_start_delim</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;[[&#39;</span><span class="p">)</span>
                <span class="c1"># Reverse find title end delimiter</span>
                <span class="n">title_end_delim</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;]]&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">url_start_delim</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">title_end_delim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Parse title</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">title_end_delim</span><span class="p">]</span>
                    <span class="c1"># Parse url</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">url_start_delim</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span><span class="n">index</span><span class="p">]</span>
                    <span class="c1"># Parse Tags</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">get_org_tags</span><span class="p">(</span><span class="n">line</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">title_end_delim</span><span class="p">):])))</span>
                    <span class="n">tags_string</span> <span class="o">=</span> <span class="n">DELIM</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">newtag</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">newtag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                            <span class="n">tags_string</span> <span class="o">=</span> <span class="p">(</span><span class="n">newtag</span> <span class="o">+</span> <span class="n">DELIM</span><span class="p">)</span> <span class="o">+</span> <span class="n">tags_string</span>

                    <span class="k">yield</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">tags_string</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="import_firefox_json"><a class="viewcode-back" href="../buku.html#buku.import_firefox_json">[docs]</a><span class="k">def</span> <span class="nf">import_firefox_json</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">add_bookmark_folder_as_tag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open Firefox JSON export file and import data.</span>
<span class="sd">    Ignore &#39;SmartBookmark&#39;  and &#39;Separator&#39;  entries.</span>

<span class="sd">    Needed/used fields out of the JSON schema of the bookmarks:</span>

<span class="sd">    title              : the name/title of the entry</span>
<span class="sd">    tags               : &#39;,&#39; separated tags for the bookmark entry</span>
<span class="sd">    typeCode           : 1 - uri, 2 - subfolder, 3 - separator</span>
<span class="sd">    annos/{name,value} : following annotation entries are used</span>
<span class="sd">        name : Places/SmartBookmark            : identifies smart folder, ignored</span>
<span class="sd">        name : bookmarkPropereties/description :  detailed bookmark entry description</span>
<span class="sd">    children           : for subfolders, recurse into the child entries</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path to Firefox JSON bookmarks file.</span>
<span class="sd">    unique_tag : str</span>
<span class="sd">        Timestamp tag in YYYYMonDD format.</span>
<span class="sd">    add_bookmark_folder_as_tag : bool</span>
<span class="sd">        True if bookmark parent folder should be added as tags else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">TypeCode</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Format</span>
<span class="sd">            typeCode</span>
<span class="sd">                1 : uri        (type=text/x-moz-place)</span>
<span class="sd">                2 : subfolder  (type=text/x-moz-container)</span>
<span class="sd">                3 : separator  (type=text/x-moz-separator)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">separator</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">is_smart</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">anno</span> <span class="k">for</span> <span class="n">anno</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;annos&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">anno</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Places/SmartBookmark&quot;</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">extract_desc</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">anno</span> <span class="k">for</span> <span class="n">anno</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;annos&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">anno</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bookmarkProperties/description&quot;</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: No description found for entry: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">extract_tags</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: No tags found for entry: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">tags</span>

    <span class="k">def</span> <span class="nf">iterate_children</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="n">entry_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bm_entry</span> <span class="ow">in</span> <span class="n">entry_list</span><span class="p">:</span>
            <span class="n">entry_title</span> <span class="o">=</span> <span class="n">bm_entry</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">bm_entry</span> <span class="k">else</span> <span class="s2">&quot;&lt;no title&gt;&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">typeCode</span> <span class="o">=</span> <span class="n">bm_entry</span><span class="p">[</span><span class="s1">&#39;typeCode&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: item without typeCode found, ignoring: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_title</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: processing typeCode &#39;</span><span class="si">{}</span><span class="s2">&#39;, title &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typeCode</span><span class="p">,</span> <span class="n">entry_title</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">TypeCode</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">typeCode</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_smart</span><span class="p">(</span><span class="n">bm_entry</span><span class="p">):</span>
                        <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: SmartBookmark found, ignoring: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_title</span><span class="p">))</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">bm_entry</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]):</span>
                        <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: Non-Generic URL found, ignoring: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_title</span><span class="p">))</span>
                        <span class="k">continue</span>

                    <span class="n">desc</span> <span class="o">=</span> <span class="n">extract_desc</span><span class="p">(</span><span class="n">bm_entry</span><span class="p">)</span>
                    <span class="n">bookmark_tags</span> <span class="o">=</span> <span class="n">extract_tags</span><span class="p">(</span><span class="n">bm_entry</span><span class="p">)</span>

                    <span class="c1"># if parent_folder is not &quot;None&quot;</span>
                    <span class="k">if</span> <span class="n">add_bookmark_folder_as_tag</span> <span class="ow">and</span> <span class="n">parent_folder</span><span class="p">:</span>
                        <span class="n">bookmark_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">unique_tag</span><span class="p">:</span>
                        <span class="n">bookmark_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_tag</span><span class="p">)</span>

                    <span class="n">formatted_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">DELIM</span> <span class="o">+</span> <span class="n">tag</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">bookmark_tags</span><span class="p">]</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">formatted_tags</span><span class="p">)</span>

                    <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: Entry found: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2"> &quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bm_entry</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">],</span> <span class="n">entry_title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span><span class="p">))</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">bm_entry</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">],</span> <span class="n">entry_title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">LOGERR</span><span class="p">(</span><span class="s2">&quot;ff_json: Error parsing entry &#39;</span><span class="si">{}</span><span class="s2">&#39; Exception &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_title</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">TypeCode</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">typeCode</span><span class="p">:</span>

                <span class="c1"># ignore special bookmark folders</span>
                <span class="k">if</span> <span class="s1">&#39;root&#39;</span> <span class="ow">in</span> <span class="n">bm_entry</span> <span class="ow">and</span> <span class="n">bm_entry</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">IGNORE_FF_BOOKMARK_FOLDERS</span><span class="p">:</span>
                    <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: ignoring root folder: </span><span class="si">{}</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_title</span><span class="p">))</span>
                    <span class="n">entry_title</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="s2">&quot;children&quot;</span> <span class="ow">in</span> <span class="n">bm_entry</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="n">iterate_children</span><span class="p">(</span><span class="n">entry_title</span><span class="p">,</span> <span class="n">bm_entry</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if any of the properties does not exist, bail out silently</span>
                    <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: No &#39;children&#39; found in bookmark folder - skipping: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry_title</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">TypeCode</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">typeCode</span><span class="p">:</span>
                <span class="c1"># ignore separator</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: Unknown typeCode found : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typeCode</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;children&quot;</span> <span class="ow">in</span> <span class="n">json</span><span class="p">:</span>
        <span class="n">main_entry_list</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="s2">&quot;ff_json: No children in Root entry found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">yield from</span> <span class="n">iterate_children</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">main_entry_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="import_html"><a class="viewcode-back" href="../buku.html#buku.import_html">[docs]</a><span class="k">def</span> <span class="nf">import_html</span><span class="p">(</span><span class="n">html_soup</span><span class="p">:</span> <span class="n">BeautifulSoup</span><span class="p">,</span> <span class="n">add_parent_folder_as_tag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">newtag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_nested_folder_structure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse bookmark HTML.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    html_soup : BeautifulSoup object</span>
<span class="sd">        BeautifulSoup representation of bookmark HTML.</span>
<span class="sd">    add_parent_folder_as_tag : bool</span>
<span class="sd">        True if bookmark parent folders should be added as tags else False.</span>
<span class="sd">    newtag : str</span>
<span class="sd">        A new unique tag to add to imported bookmarks.</span>
<span class="sd">    use_nested_folder_structure: bool</span>
<span class="sd">        True if all bookmark parent folder should be added, not just direct parent else False</span>
<span class="sd">        add_parent_folder_as_tag must be True for this flag to have an effect</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Parsed result.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># compatibility</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">html_soup</span>

    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
        <span class="c1"># Extract comment from &lt;dd&gt; tag</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">]):</span>
                <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comment_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">findNextSibling</span><span class="p">(</span><span class="s1">&#39;dd&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comment_tag</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">comment_tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_parent_folder_as_tag</span><span class="p">:</span>
            <span class="c1"># add parent folder as tag</span>
            <span class="k">if</span> <span class="n">use_nested_folder_structure</span><span class="p">:</span>
                <span class="c1"># New method that would generalize for else case too</span>
                <span class="c1"># Stucture of folders</span>
                <span class="c1"># dt</span>
                <span class="c1">#   h3 (folder name)</span>
                <span class="c1">#   dl</span>
                <span class="c1">#       dt</span>
                <span class="c1">#           a (could be h3, and continue recursively)</span>
                <span class="n">parents</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">find_parents</span><span class="p">(</span><span class="s1">&#39;dl&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">find_previous_sibling</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">):</span>
                            <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">DELIM</span> <span class="o">+</span> <span class="n">header</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># could be its folder or not</span>
                <span class="n">possible_folder</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">find_previous</span><span class="p">(</span><span class="s1">&#39;h3&#39;</span><span class="p">)</span>
                <span class="c1"># get list of tags within that folder</span>
                <span class="n">tag_list</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">find_parent</span><span class="p">(</span><span class="s1">&#39;dl&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">((</span><span class="n">possible_folder</span><span class="p">)</span> <span class="ow">and</span> <span class="n">possible_folder</span><span class="o">.</span><span class="n">parent</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tag_list</span><span class="o">.</span><span class="n">parents</span><span class="p">)):</span>
                    <span class="c1"># then it&#39;s the folder of this bookmark</span>
                    <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">):</span>
                        <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">DELIM</span> <span class="o">+</span> <span class="n">possible_folder</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">possible_folder</span><span class="o">.</span><span class="n">text</span>

        <span class="c1"># add unique tag if opted</span>
        <span class="k">if</span> <span class="n">newtag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">):</span>
                <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">DELIM</span> <span class="o">+</span> <span class="n">newtag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newtag</span>

        <span class="k">yield</span> <span class="p">(</span>
            <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;href&#39;</span><span class="p">],</span> <span class="n">tag</span><span class="o">.</span><span class="n">string</span><span class="p">,</span>
            <span class="n">parse_tags</span><span class="p">([</span><span class="n">tag</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]])</span> <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">has_attr</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">desc</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span> <span class="k">else</span> <span class="n">desc</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="is_bad_url"><a class="viewcode-back" href="../buku.html#buku.is_bad_url">[docs]</a><span class="k">def</span> <span class="nf">is_bad_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if URL is malformed.</span>

<span class="sd">    .. Note:: This API is not bulletproof but works in most cases.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to scan.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if URL is malformed, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the netloc token</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">netloc</span> <span class="o">=</span> <span class="n">parse_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">netloc</span><span class="p">:</span>
            <span class="c1"># Try of prepend &#39;//&#39; and get netloc</span>
            <span class="n">netloc</span> <span class="o">=</span> <span class="n">parse_url</span><span class="p">(</span><span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">netloc</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">netloc</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">LocationParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, URL: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;netloc: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">netloc</span><span class="p">)</span>

    <span class="c1"># netloc cannot start or end with a &#39;.&#39;</span>
    <span class="k">if</span> <span class="n">netloc</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">netloc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># netloc should have at least one &#39;.&#39;</span>
    <span class="k">if</span> <span class="n">netloc</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_nongeneric_url"><a class="viewcode-back" href="../buku.html#buku.is_nongeneric_url">[docs]</a><span class="k">def</span> <span class="nf">is_nongeneric_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True for URLs which are non-http and non-generic.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to scan.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if URL is a non-generic URL, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ignored_prefix</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;about:&#39;</span><span class="p">,</span>
        <span class="s1">&#39;apt:&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chrome://&#39;</span><span class="p">,</span>
        <span class="s1">&#39;file://&#39;</span><span class="p">,</span>
        <span class="s1">&#39;place:&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">ignored_prefix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_ignored_mime"><a class="viewcode-back" href="../buku.html#buku.is_ignored_mime">[docs]</a><span class="k">def</span> <span class="nf">is_ignored_mime</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if URL links to ignored MIME.</span>

<span class="sd">    .. Note:: Only a &#39;HEAD&#39; request is made for these URLs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to scan.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if URL links to ignored MIME, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">mime</span> <span class="ow">in</span> <span class="n">SKIP_MIMES</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">mime</span><span class="p">):</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;matched MIME: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">mime</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="is_unusual_tag"><a class="viewcode-back" href="../buku.html#buku.is_unusual_tag">[docs]</a><span class="k">def</span> <span class="nf">is_unusual_tag</span><span class="p">(</span><span class="n">tagstr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify unusual tags with word to comma ratio &gt; 3.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tagstr : str</span>
<span class="sd">        tag string to check.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if valid tag else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tagstr</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">nwords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tagstr</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">ncommas</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">nwords</span> <span class="o">/</span> <span class="n">ncommas</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="parse_decoded_page"><a class="viewcode-back" href="../buku.html#buku.parse_decoded_page">[docs]</a><span class="k">def</span> <span class="nf">parse_decoded_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fetch title, description and keywords from decoded HTML page.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    page : str</span>
<span class="sd">        Decoded HTML page.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (title, description, keywords).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s1">&#39;html5lib&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s{2,}&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">description</span> <span class="o">=</span> <span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;description&#39;</span><span class="p">})</span> <span class="ow">or</span>
                   <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Description&#39;</span><span class="p">})</span> <span class="ow">or</span>
                   <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;property&#39;</span><span class="p">:</span><span class="s1">&#39;description&#39;</span><span class="p">})</span> <span class="ow">or</span>
                   <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;property&#39;</span><span class="p">:</span><span class="s1">&#39;Description&#39;</span><span class="p">})</span> <span class="ow">or</span>
                   <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;og:description&#39;</span><span class="p">})</span> <span class="ow">or</span>
                   <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;og:Description&#39;</span><span class="p">})</span> <span class="ow">or</span>
                   <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;property&#39;</span><span class="p">:</span><span class="s1">&#39;og:description&#39;</span><span class="p">})</span> <span class="ow">or</span>
                   <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;property&#39;</span><span class="p">:</span><span class="s1">&#39;og:Description&#39;</span><span class="p">}))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s{2,}&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;keywords&#39;</span><span class="p">})</span> <span class="ow">or</span>
                <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;Keywords&#39;</span><span class="p">}))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s{2,}&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_unusual_tag</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">keys</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
                    <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;keywords to description: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
                        <span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## &#39;</span> <span class="o">+</span> <span class="n">keys</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">desc</span> <span class="o">=</span> <span class="s1">&#39;* &#39;</span> <span class="o">+</span> <span class="n">keys</span>

                <span class="n">keys</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;title: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;desc : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>
    <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;keys : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_data_from_page"><a class="viewcode-back" href="../buku.html#buku.get_data_from_page">[docs]</a><span class="k">def</span> <span class="nf">get_data_from_page</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Detect HTTP response encoding and invoke parser with decoded data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resp : HTTP response</span>
<span class="sd">        Response from GET request.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (title, description, keywords).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;get_data_from_page(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">charset</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">soup</span><span class="o">.</span><span class="n">meta</span> <span class="ow">and</span> <span class="n">soup</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;charset&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">charset</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;charset&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;content-type&#39;</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;charset&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">charset</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;charset&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">charset</span> <span class="ow">and</span> <span class="n">soup</span><span class="p">:</span>
            <span class="n">meta_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;http-equiv&#39;</span><span class="p">:</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">meta_tag</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="n">meta_tag</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">])</span>
                <span class="n">charset</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;charset&#39;</span><span class="p">,</span> <span class="n">charset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">charset</span><span class="p">:</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;charset: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">charset</span><span class="p">)</span>
            <span class="n">title</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">parse_decoded_page</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">charset</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">parse_decoded_page</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">keywords</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="gen_headers"><a class="viewcode-back" href="../buku.html#buku.gen_headers">[docs]</a><span class="k">def</span> <span class="nf">gen_headers</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Generate headers for network connection.&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">MYHEADERS</span><span class="p">,</span> <span class="n">MYPROXY</span>

    <span class="n">MYHEADERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip,deflate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">,</span>
        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;*/*&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Cookie&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DNT&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span>
    <span class="p">}</span>

    <span class="n">MYPROXY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https_proxy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MYPROXY</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">parse_url</span><span class="p">(</span><span class="n">MYPROXY</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Strip username and password (if present) and update headers</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">auth</span><span class="p">:</span>
            <span class="n">MYPROXY</span> <span class="o">=</span> <span class="n">MYPROXY</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">auth</span> <span class="o">+</span> <span class="s1">&#39;@&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">auth_headers</span> <span class="o">=</span> <span class="n">make_headers</span><span class="p">(</span><span class="n">basic_auth</span><span class="o">=</span><span class="n">url</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
            <span class="n">MYHEADERS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">auth_headers</span><span class="p">)</span>

        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;proxy: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">MYPROXY</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_PoolManager"><a class="viewcode-back" href="../buku.html#buku.get_PoolManager">[docs]</a><span class="k">def</span> <span class="nf">get_PoolManager</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Creates a pool manager with proxy support, if applicable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ProxyManager or PoolManager</span>
<span class="sd">        ProxyManager if https_proxy is defined, PoolManager otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ca_certs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUKU_CA_CERTS&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">CA_CERTS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MYPROXY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">ProxyManager</span><span class="p">(</span><span class="n">MYPROXY</span><span class="p">,</span> <span class="n">num_pools</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">MYHEADERS</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                                    <span class="n">cert_reqs</span><span class="o">=</span><span class="s1">&#39;CERT_REQUIRED&#39;</span><span class="p">,</span> <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">PoolManager</span><span class="p">(</span>
        <span class="n">num_pools</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="n">MYHEADERS</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
        <span class="n">cert_reqs</span><span class="o">=</span><span class="s1">&#39;CERT_REQUIRED&#39;</span><span class="p">,</span>
        <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">)</span></div>


<div class="viewcode-block" id="network_handler"><a class="viewcode-back" href="../buku.html#buku.network_handler">[docs]</a><span class="k">def</span> <span class="nf">network_handler</span><span class="p">(</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">http_head</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Handle server connection and redirections.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to fetch.</span>
<span class="sd">    http_head : bool</span>
<span class="sd">        If True, send only HTTP HEAD request. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (title, description, tags, recognized mime, bad url).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">page_title</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">page_desc</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">page_keys</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">exception</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">is_nongeneric_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_bad_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_ignored_mime</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="ow">or</span> <span class="n">http_head</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;HEAD&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">MYHEADERS</span><span class="p">:</span>
        <span class="n">gen_headers</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">get_PoolManager</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="n">Retry</span><span class="p">(</span><span class="n">redirect</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
                    <span class="n">page_title</span><span class="p">,</span> <span class="n">page_desc</span><span class="p">,</span> <span class="n">page_keys</span> <span class="o">=</span> <span class="n">get_data_from_page</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">403</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="c1"># HTTP response Forbidden</span>
                <span class="c1"># Handle URLs in the form of https://www.domain.com/</span>
                <span class="c1"># which fail when trying to fetch resource &#39;/&#39;</span>
                <span class="c1"># retry without trailing &#39;/&#39;</span>

                <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;Received status 403: retrying...&#39;</span><span class="p">)</span>
                <span class="c1"># Remove trailing /</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">break</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;network_handler(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">exception</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">manager</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page_title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">page_desc</span><span class="p">,</span> <span class="n">page_keys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">page_title</span><span class="p">,</span> <span class="n">page_desc</span><span class="p">,</span> <span class="n">page_keys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_tags"><a class="viewcode-back" href="../buku.html#buku.parse_tags">[docs]</a><span class="k">def</span> <span class="nf">parse_tags</span><span class="p">(</span><span class="n">keywords</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Format and get tag string from tokens.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    keywords : list, optional</span>
<span class="sd">        List of tags to parse. Default is empty list.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Comma-delimited string of tags.</span>
<span class="sd">    DELIM : str</span>
<span class="sd">        If no keywords, returns the delimiter.</span>
<span class="sd">    None</span>
<span class="sd">        If keywords is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">keywords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">DELIM</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>

    <span class="c1"># Cleanse and get the tags</span>
    <span class="n">tagstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">marker</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">tagstr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">marker</span><span class="p">]</span>
        <span class="n">tagstr</span> <span class="o">=</span> <span class="n">tagstr</span><span class="p">[</span><span class="n">marker</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">tags</span> <span class="o">+=</span> <span class="n">token</span> <span class="o">+</span> <span class="n">DELIM</span>

    <span class="n">tagstr</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tagstr</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">+=</span> <span class="n">tagstr</span> <span class="o">+</span> <span class="n">DELIM</span>

    <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;keywords: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">keywords</span><span class="p">)</span>
    <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;parsed tags: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="n">DELIM</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tags</span>

    <span class="c1"># original tags in lower case</span>
    <span class="n">orig_tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>

    <span class="c1"># Create list of unique tags and sort</span>
    <span class="n">unique_tags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">orig_tags</span><span class="p">))</span>

    <span class="c1"># Wrap with delimiter</span>
    <span class="k">return</span> <span class="n">delim_wrap</span><span class="p">(</span><span class="n">DELIM</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_tags</span><span class="p">))</span></div>


<div class="viewcode-block" id="prep_tag_search"><a class="viewcode-back" href="../buku.html#buku.prep_tag_search">[docs]</a><span class="k">def</span> <span class="nf">prep_tag_search</span><span class="p">(</span><span class="n">tags</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Prepare list of tags to search and determine search operator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tags : str</span>
<span class="sd">        String list of tags to search.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (list of formatted tags to search,</span>
<span class="sd">         a string indicating query search operator (either OR or AND),</span>
<span class="sd">         a regex string of tags or None if &#39; - &#39; delimiter not in tags).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">exclude_only</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># tags may begin with `- ` if only exclusion list is provided</span>
    <span class="k">if</span> <span class="n">tags</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;- &#39;</span><span class="p">):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">tags</span>
        <span class="n">exclude_only</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># tags may start with `+ ` etc., tricky test case</span>
    <span class="k">if</span> <span class="n">tags</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;+ &#39;</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">)):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="c1"># tags may end with ` -` etc., tricky test case</span>
    <span class="k">if</span> <span class="n">tags</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39; -&#39;</span><span class="p">,</span> <span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; ,&#39;</span><span class="p">)):</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># tag exclusion list can be separated by comma (,), so split it first</span>
    <span class="n">excluded_tags</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39; - &#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="n">tags</span><span class="p">,</span> <span class="n">excluded_tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; - &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">excluded_taglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">delim_wrap</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">excluded_tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="c1"># join with pipe to construct regex string</span>
        <span class="n">excluded_tags</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">excluded_taglist</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exclude_only</span><span class="p">:</span>
        <span class="n">search_operator</span> <span class="o">=</span> <span class="s1">&#39;OR&#39;</span>
        <span class="n">tags_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># do not allow combination of search logics in tag inclusion list</span>
        <span class="k">if</span> <span class="s1">&#39; + &#39;</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">and</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">search_operator</span> <span class="o">=</span> <span class="s1">&#39;OR&#39;</span>
        <span class="n">tag_delim</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
        <span class="k">if</span> <span class="s1">&#39; + &#39;</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="n">search_operator</span> <span class="o">=</span> <span class="s1">&#39;AND&#39;</span>
            <span class="n">tag_delim</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span>

        <span class="n">tags_</span> <span class="o">=</span> <span class="p">[</span><span class="n">delim_wrap</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">tag_delim</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">tags_</span><span class="p">,</span> <span class="n">search_operator</span><span class="p">,</span> <span class="n">excluded_tags</span></div>


<div class="viewcode-block" id="gen_auto_tag"><a class="viewcode-back" href="../buku.html#buku.gen_auto_tag">[docs]</a><span class="k">def</span> <span class="nf">gen_auto_tag</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Generate a tag in Year-Month-Date format.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        New tag as YYYYMonDD.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%d%s%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">)</span></div>


<div class="viewcode-block" id="edit_at_prompt"><a class="viewcode-back" href="../buku.html#buku.edit_at_prompt">[docs]</a><span class="k">def</span> <span class="nf">edit_at_prompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">suggest</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit and add or update a bookmark.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : BukuDb instance</span>
<span class="sd">        A valid instance of BukuDb class.</span>
<span class="sd">    nav : str</span>
<span class="sd">        Navigation command argument passed at prompt by user.</span>
<span class="sd">    suggest : bool, optional</span>
<span class="sd">        If True, suggest similar tags on new bookmark addition.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">get_system_editor</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_editor_valid</span><span class="p">(</span><span class="n">editor</span><span class="p">):</span>
            <span class="k">return</span>
    <span class="k">elif</span> <span class="n">is_int</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">edit_update_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">editor</span> <span class="o">=</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">edit_rec</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">DELIM</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">suggest</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">suggest_similar_tag</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_taglist"><a class="viewcode-back" href="../buku.html#buku.show_taglist">[docs]</a><span class="k">def</span> <span class="nf">show_taglist</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Additional prompt to show unique tag list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : BukuDb instance</span>
<span class="sd">        A valid instance of BukuDb class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unique_tags</span><span class="p">,</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_tag_all</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">unique_tags</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;0 tags&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">unique_tags</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%6d</span><span class="s1">. </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">dic</span><span class="p">[</span><span class="n">tag</span><span class="p">]))</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">()</span></div>


<div class="viewcode-block" id="prompt"><a class="viewcode-back" href="../buku.html#buku.prompt">[docs]</a><span class="k">def</span> <span class="nf">prompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">noninteractive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">listtags</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suggest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show each matching result from a search and prompt.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : BukuDb instance</span>
<span class="sd">        A valid instance of BukuDb class.</span>
<span class="sd">    results : list</span>
<span class="sd">        Search result set from a DB query.</span>
<span class="sd">    noninteractive : bool, optional</span>
<span class="sd">        If True, does not seek user input. Shows all results. Default is False.</span>
<span class="sd">    deep : bool, optional</span>
<span class="sd">        Use deep search. Default is False.</span>
<span class="sd">    listtags : bool, optional</span>
<span class="sd">        If True, list all tags.</span>
<span class="sd">    suggest : bool, optional</span>
<span class="sd">        If True, suggest similar tags on edit and add bookmark.</span>
<span class="sd">    num : int, optional</span>
<span class="sd">        Number of results to show per page. Default is 10.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">BukuDb</span><span class="p">):</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Not a BukuDb instance&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">new_results</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">nav</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">cur_index</span> <span class="o">=</span> <span class="n">next_index</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">listtags</span><span class="p">:</span>
        <span class="n">show_taglist</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">columns</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">noninteractive</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">print_single_rec</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">return</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">new_results</span> <span class="ow">or</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">total_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="n">cur_index</span> <span class="o">=</span> <span class="n">next_index</span>
                <span class="k">if</span> <span class="n">cur_index</span> <span class="o">&lt;</span> <span class="n">total_results</span><span class="p">:</span>
                    <span class="n">next_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cur_index</span> <span class="o">+</span> <span class="n">num</span><span class="p">,</span> <span class="n">total_results</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="n">cur_index</span><span class="p">:</span><span class="n">next_index</span><span class="p">]:</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">print_single_rec</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cur_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">next_index</span><span class="p">,</span> <span class="n">total_results</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No more results&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;0 results&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="n">PROMPTMSG</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nav</span><span class="p">:</span>
                <span class="n">nav</span> <span class="o">=</span> <span class="n">read_in</span><span class="p">(</span><span class="n">PROMPTMSG</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">nav</span><span class="p">:</span>
                    <span class="c1"># Quit on double enter</span>
                    <span class="k">break</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="n">nav</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># show the next set of results from previous search</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># search ANY match with new keywords</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;s &#39;</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cur_index</span> <span class="o">=</span> <span class="n">next_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">continue</span>

        <span class="c1"># search ALL match with new keywords</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;S &#39;</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cur_index</span> <span class="o">=</span> <span class="n">next_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">continue</span>

        <span class="c1"># regular expressions search with new keywords</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;r &#39;</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cur_index</span> <span class="o">=</span> <span class="n">next_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">continue</span>

        <span class="c1"># tag search with new keywords</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;t &#39;</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">search_by_tag</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cur_index</span> <span class="o">=</span> <span class="n">next_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">continue</span>

        <span class="c1"># quit with &#39;q&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># No new results fetched beyond this point</span>
        <span class="n">new_results</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># toggle deep search with &#39;d&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
            <span class="n">deep</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">deep</span>
            <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deep search on&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;deep search off&#39;</span><span class="p">)</span>

            <span class="k">continue</span>

        <span class="c1"># Toggle GUI browser with &#39;O&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
            <span class="n">browse</span><span class="o">.</span><span class="n">override_text_browser</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">browse</span><span class="o">.</span><span class="n">override_text_browser</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;text browser override toggled&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Show help with &#39;?&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">ExtendedArgumentParser</span><span class="o">.</span><span class="n">prompt_help</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Edit and add or update</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span> <span class="ow">or</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;w &#39;</span><span class="p">):</span>
            <span class="n">edit_at_prompt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">nav</span><span class="p">,</span> <span class="n">suggest</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Append or overwrite tags</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;g &#39;</span><span class="p">):</span>
            <span class="n">unique_tags</span><span class="p">,</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_tag_all</span><span class="p">()</span>
            <span class="n">_count</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">unique_tags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_count</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tagid_list</span> <span class="o">=</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">tagstr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_tagstr_from_taglist</span><span class="p">(</span><span class="n">tagid_list</span><span class="p">,</span> <span class="n">unique_tags</span><span class="p">)</span>
                    <span class="n">tagstr</span> <span class="o">=</span> <span class="n">tagstr</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">)</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">search_by_tag</span><span class="p">(</span><span class="n">tagstr</span><span class="p">)</span>
                    <span class="n">new_results</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cur_index</span> <span class="o">=</span> <span class="n">next_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> updated&#39;</span> <span class="o">%</span> <span class="n">_count</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Print bookmarks by DB index</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;p &#39;</span><span class="p">):</span>
            <span class="n">id_list</span> <span class="o">=</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Browse bookmarks by DB index</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;o &#39;</span><span class="p">):</span>
            <span class="n">id_list</span> <span class="o">=</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">id_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Copy URL to clipboard</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;c &#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No matching index&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">copy_to_clipboard</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">cur_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="c1"># open all results and re-prompt with &#39;a&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cur_index</span><span class="p">,</span> <span class="n">next_index</span><span class="p">):</span>
                <span class="n">browse</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">continue</span>

        <span class="c1"># list tags with &#39;t&#39;</span>
        <span class="k">if</span> <span class="n">nav</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
            <span class="n">show_taglist</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">toggled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Open in GUI browser</span>
        <span class="k">if</span> <span class="n">nav</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;O &#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">browse</span><span class="o">.</span><span class="n">override_text_browser</span><span class="p">:</span>
                <span class="n">browse</span><span class="o">.</span><span class="n">override_text_browser</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">toggled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">nav</span> <span class="o">=</span> <span class="n">nav</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

        <span class="c1"># iterate over white-space separated indices</span>
        <span class="k">for</span> <span class="n">nav</span> <span class="ow">in</span> <span class="n">nav</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">nav</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nav</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nav</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">browse</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="n">cur_index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">nav</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nav</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">_id</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
                            <span class="n">browse</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">_id</span> <span class="o">+</span> <span class="n">cur_index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No matching index </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid input&#39;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">toggled</span><span class="p">:</span>
            <span class="n">browse</span><span class="o">.</span><span class="n">override_text_browser</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="copy_to_clipboard"><a class="viewcode-back" href="../buku.html#buku.copy_to_clipboard">[docs]</a><span class="k">def</span> <span class="nf">copy_to_clipboard</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy content to clipboard</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    content : str</span>
<span class="sd">        Content to be copied to clipboard</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># try copying the url to clipboard using native utilities</span>
    <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;freebsd&#39;</span><span class="p">,</span> <span class="s1">&#39;openbsd&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;xsel&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xsel&#39;</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;xclip&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xclip&#39;</span><span class="p">,</span> <span class="s1">&#39;-selection&#39;</span><span class="p">,</span> <span class="s1">&#39;clipboard&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;wl-copy&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;wl-copy&#39;</span><span class="p">]</span>
        <span class="c1"># If we&#39;re using Termux (Android) use its &#39;termux-api&#39;</span>
        <span class="c1"># add-on to set device clipboard.</span>
        <span class="k">elif</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">&#39;termux-clipboard-set&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;termux-clipboard-set&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
        <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pbcopy&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
        <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clip&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">copier_params</span><span class="p">:</span>
        <span class="n">Popen</span><span class="p">(</span><span class="n">copier_params</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># If native clipboard utilities are absent, try to use terminal multiplexers</span>
    <span class="c1"># tmux</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;TMUX_PANE&#39;</span><span class="p">):</span>
        <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;set-buffer&#39;</span><span class="p">]</span>
        <span class="n">Popen</span><span class="p">(</span>
            <span class="n">copier_params</span> <span class="o">+</span> <span class="p">[</span><span class="n">content</span><span class="p">],</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span>
        <span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;URL copied to tmux buffer.&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># GNU Screen paste buffer</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;STY&#39;</span><span class="p">):</span>
        <span class="n">copier_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span> <span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;readbuf&#39;</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">]</span>
        <span class="n">tmpfd</span><span class="p">,</span> <span class="n">tmppath</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">tmpfd</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="n">copier_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmppath</span><span class="p">)</span>
            <span class="n">Popen</span><span class="p">(</span><span class="n">copier_params</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">DEVNULL</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmppath</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to locate suitable clipboard utility&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="print_rec_with_filter"><a class="viewcode-back" href="../buku.html#buku.print_rec_with_filter">[docs]</a><span class="k">def</span> <span class="nf">print_rec_with_filter</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print records filtered by field.</span>

<span class="sd">    User determines which fields in the records to display</span>
<span class="sd">    by using the --format option.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    records : list or sqlite3.Cursor object</span>
<span class="sd">        List of bookmark records to print</span>
<span class="sd">    field_filter : int</span>
<span class="sd">        Integer indicating which fields to print.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">columns</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">print_single_rec</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\t</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">BrokenPipeError</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_single_rec"><a class="viewcode-back" href="../buku.html#buku.print_single_rec">[docs]</a><span class="k">def</span> <span class="nf">print_single_rec</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">BookmarkVar</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>  <span class="c1"># NOQA</span>
    <span class="sd">&quot;&quot;&quot;Print a single DB record.</span>

<span class="sd">    Handles both search results and individual record.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row : tuple</span>
<span class="sd">        Tuple representing bookmark record data.</span>
<span class="sd">    idx : int, optional</span>
<span class="sd">        Search result index. If 0, print with DB index.</span>
<span class="sd">        Default is 0.</span>
<span class="sd">    columns : int, optional</span>
<span class="sd">        Number of columns to wrap comments to.</span>
<span class="sd">        Default is 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">str_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Start with index and title</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">id_title_res</span> <span class="o">=</span> <span class="n">ID_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Untitled&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">id_title_res</span> <span class="o">=</span> <span class="n">ID_DB_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;Untitled&#39;</span><span class="p">)</span>
        <span class="c1"># Indicate if record is immutable</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">id_title_res</span> <span class="o">=</span> <span class="n">MUTE_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">id_title_res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_title_res</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">id_title_res</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">URL_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">DESC_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">TAG_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">INDENT</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">ln_num</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fillwidth</span> <span class="o">=</span> <span class="n">columns</span> <span class="o">-</span> <span class="n">INDENT</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">fillwidth</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ln_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">DESC_STR</span> <span class="o">%</span> <span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ln_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">DESC_WRAP</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">INDENT</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

        <span class="n">ln_num</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">fillwidth</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ln_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">TAG_STR</span> <span class="o">%</span> <span class="n">line</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ln_num</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">TAG_WRAP</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">INDENT</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
        <span class="n">str_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_title_res</span><span class="p">)</span>
        <span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">URL_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DESC_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
            <span class="n">str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TAG_STR</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">str_list</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">BrokenPipeError</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_string_to_file"><a class="viewcode-back" href="../buku.html#buku.write_string_to_file">[docs]</a><span class="k">def</span> <span class="nf">write_string_to_file</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Writes given content to file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    content : str</span>
<span class="sd">    filepath : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="format_json"><a class="viewcode-back" href="../buku.html#buku.format_json">[docs]</a><span class="k">def</span> <span class="nf">format_json</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="n">single_record</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return results in JSON format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resultset : list</span>
<span class="sd">        Search results from DB query.</span>
<span class="sd">    single_record : bool, optional</span>
<span class="sd">        If True, indicates only one record. Default is False.</span>
<span class="sd">    field_filter : int, optional</span>
<span class="sd">        Indicates format for displaying bookmarks. Default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    json</span>
<span class="sd">        Record(s) in JSON format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">single_record</span><span class="p">:</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">marks</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">resultset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
            <span class="k">elif</span> <span class="n">field_filter</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;uri&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                    <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">}</span>

            <span class="n">marks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">marks</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_json_safe"><a class="viewcode-back" href="../buku.html#buku.print_json_safe">[docs]</a><span class="k">def</span> <span class="nf">print_json_safe</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="n">single_record</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints json results and handles IOError</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resultset : list</span>
<span class="sd">        Search results from DB query.</span>
<span class="sd">    single_record : bool, optional</span>
<span class="sd">        If True, indicates only one record. Default is False.</span>
<span class="sd">    field_filter : int, optional</span>
<span class="sd">        Indicates format for displaying bookmarks. Default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">format_json</span><span class="p">(</span><span class="n">resultset</span><span class="p">,</span> <span class="n">single_record</span><span class="p">,</span> <span class="n">field_filter</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="is_int"><a class="viewcode-back" href="../buku.html#buku.is_int">[docs]</a><span class="k">def</span> <span class="nf">is_int</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if a string is a digit.</span>

<span class="sd">    string : str</span>
<span class="sd">        Input string to check.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True on success, False on exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="browse"><a class="viewcode-back" href="../buku.html#buku.browse">[docs]</a><span class="k">def</span> <span class="nf">browse</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Duplicate stdin, stdout and open URL in default browser.</span>

<span class="sd">    .. Note:: Duplicates stdin and stdout in order to</span>
<span class="sd">              suppress showing errors on the terminal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to open in browser.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    suppress_browser_output : bool</span>
<span class="sd">        True if a text based browser is detected.</span>
<span class="sd">        Must be initialized (as applicable) to use the API.</span>
<span class="sd">    override_text_browser : bool</span>
<span class="sd">        If True, tries to open links in a GUI based browser.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">parse_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span><span class="p">:</span>
        <span class="c1"># Prefix with &#39;http://&#39; if no scheme</span>
        <span class="c1"># Otherwise, opening in browser fails anyway</span>
        <span class="c1"># We expect http to https redirection</span>
        <span class="c1"># will happen for https-only websites</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Scheme missing in URI, trying http&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">url</span>

    <span class="n">browser</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">browse</span><span class="o">.</span><span class="n">override_text_browser</span><span class="p">:</span>
        <span class="n">browser_output</span> <span class="o">=</span> <span class="n">browse</span><span class="o">.</span><span class="n">suppress_browser_output</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">webbrowser</span><span class="o">.</span><span class="n">_tryorder</span> <span class="k">if</span> <span class="n">b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TEXT_BROWSERS</span><span class="p">]:</span>
            <span class="n">browser</span> <span class="o">=</span> <span class="n">webbrowser</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="n">browser</span><span class="p">)</span>

            <span class="c1"># Found a GUI browser, suppress browser output</span>
            <span class="n">browse</span><span class="o">.</span><span class="n">suppress_browser_output</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">browse</span><span class="o">.</span><span class="n">suppress_browser_output</span><span class="p">:</span>
        <span class="n">_stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">_stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;microsoft&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">platform</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
            <span class="n">browser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On Windows, the webbrowser module does not fork.</span>
            <span class="c1"># Use threads instead.</span>
            <span class="k">def</span> <span class="nf">browserthread</span><span class="p">():</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">browserthread</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;browse(): </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">browse</span><span class="o">.</span><span class="n">suppress_browser_output</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">_stderr</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">_stdout</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">browse</span><span class="o">.</span><span class="n">override_text_browser</span><span class="p">:</span>
        <span class="n">browse</span><span class="o">.</span><span class="n">suppress_browser_output</span> <span class="o">=</span> <span class="n">browser_output</span></div>


<div class="viewcode-block" id="check_upstream_release"><a class="viewcode-back" href="../buku.html#buku.check_upstream_release">[docs]</a><span class="k">def</span> <span class="nf">check_upstream_release</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Check and report the latest upstream release version.&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">MYPROXY</span>

    <span class="k">if</span> <span class="n">MYPROXY</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gen_headers</span><span class="p">()</span>

    <span class="n">ca_certs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUKU_CA_CERTS&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">CA_CERTS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MYPROXY</span><span class="p">:</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">ProxyManager</span><span class="p">(</span>
            <span class="n">MYPROXY</span><span class="p">,</span>
            <span class="n">num_pools</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">MYHEADERS</span><span class="p">,</span>
            <span class="n">cert_reqs</span><span class="o">=</span><span class="s1">&#39;CERT_REQUIRED&#39;</span><span class="p">,</span>
            <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">PoolManager</span><span class="p">(</span><span class="n">num_pools</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">},</span>
                                      <span class="n">cert_reqs</span><span class="o">=</span><span class="s1">&#39;CERT_REQUIRED&#39;</span><span class="p">,</span>
                                      <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
            <span class="s1">&#39;https://api.github.com/repos/jarun/buku/releases?per_page=1&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;tag_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">latest</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span> <span class="o">+</span> <span class="n">__version__</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This is the latest release&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Latest upstream release is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">latest</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>

    <span class="n">manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>


<div class="viewcode-block" id="regexp"><a class="viewcode-back" href="../buku.html#buku.regexp">[docs]</a><span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform a regular expression search.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expr : regex</span>
<span class="sd">        Regular expression to search for.</span>
<span class="sd">    item : str</span>
<span class="sd">        Item on which to perform regex search.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if result of search is not None, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;expr: [</span><span class="si">%s</span><span class="s1">], item: [</span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="delim_wrap"><a class="viewcode-back" href="../buku.html#buku.delim_wrap">[docs]</a><span class="k">def</span> <span class="nf">delim_wrap</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns token string wrapped in delimiters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    token : str</span>
<span class="sd">        String item to wrap with DELIM.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Token string wrapped by DELIM.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DELIM</span>

    <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">DELIM</span> <span class="o">+</span> <span class="n">token</span>

    <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DELIM</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">token</span> <span class="o">+</span> <span class="n">DELIM</span>

    <span class="k">return</span> <span class="n">token</span></div>


<div class="viewcode-block" id="read_in"><a class="viewcode-back" href="../buku.html#buku.read_in">[docs]</a><span class="k">def</span> <span class="nf">read_in</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper to handle input() with interrupts disabled.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msg : str</span>
<span class="sd">        String to pass to to input().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">disable_sigint_handler</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Interrupted.&#39;</span><span class="p">)</span>

    <span class="n">enable_sigint_handler</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">message</span></div>


<div class="viewcode-block" id="sigint_handler"><a class="viewcode-back" href="../buku.html#buku.sigint_handler">[docs]</a><span class="k">def</span> <span class="nf">sigint_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Custom SIGINT handler.</span>

<span class="sd">    .. Note:: Neither signum nor frame are used in</span>
<span class="sd">              this custom handler. However, they are</span>
<span class="sd">              required parameters for signal handlers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signum : int</span>
<span class="sd">        Signal number.</span>
<span class="sd">    frame : frame object or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">INTERRUPTED</span>

    <span class="n">INTERRUPTED</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Interrupted.&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="c1"># Do a hard exit from here</span>
    <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<span class="n">DEFAULT_HANDLER</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigint_handler</span><span class="p">)</span>


<div class="viewcode-block" id="disable_sigint_handler"><a class="viewcode-back" href="../buku.html#buku.disable_sigint_handler">[docs]</a><span class="k">def</span> <span class="nf">disable_sigint_handler</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Disable signint handler.&quot;&quot;&quot;</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">DEFAULT_HANDLER</span><span class="p">)</span></div>


<div class="viewcode-block" id="enable_sigint_handler"><a class="viewcode-back" href="../buku.html#buku.enable_sigint_handler">[docs]</a><span class="k">def</span> <span class="nf">enable_sigint_handler</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Enable sigint handler.&quot;&quot;&quot;</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sigint_handler</span><span class="p">)</span></div>

<span class="c1"># ---------------------</span>
<span class="c1"># Editor mode functions</span>
<span class="c1"># ---------------------</span>


<div class="viewcode-block" id="get_system_editor"><a class="viewcode-back" href="../buku.html#buku.get_system_editor">[docs]</a><span class="k">def</span> <span class="nf">get_system_editor</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns default system editor is $EDITOR is set.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;EDITOR&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_editor_valid"><a class="viewcode-back" href="../buku.html#buku.is_editor_valid">[docs]</a><span class="k">def</span> <span class="nf">is_editor_valid</span><span class="p">(</span><span class="n">editor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if the editor string is valid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    editor : str</span>
<span class="sd">        Editor string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if string is valid, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">editor</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;EDITOR is not set&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">editor</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Cannot edit index 0&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="to_temp_file_content"><a class="viewcode-back" href="../buku.html#buku.to_temp_file_content">[docs]</a><span class="k">def</span> <span class="nf">to_temp_file_content</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate temporary file content string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    url : str</span>
<span class="sd">        URL to open.</span>
<span class="sd">    title_in : str</span>
<span class="sd">        Title to add manually.</span>
<span class="sd">    tags_in : str</span>
<span class="sd">        Comma-separated tags to add manually.</span>
<span class="sd">    desc : str</span>
<span class="sd">        String description.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Lines as newline separated string.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    AttributeError</span>
<span class="sd">        when tags_in is None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">strings</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;# Lines beginning with &quot;#&quot; will be stripped.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;# Add URL in next line (single line).&#39;</span><span class="p">),</span> <span class="p">]</span>

    <span class="c1"># URL</span>
    <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="n">url</span><span class="p">,)</span>

    <span class="c1"># TITLE</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">((</span><span class="s1">&#39;# Add TITLE in next line (single line). &#39;</span>
                 <span class="s1">&#39;Leave blank to web fetch, &quot;-&quot; for no title.&#39;</span><span class="p">),)</span>
    <span class="k">if</span> <span class="n">title_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">elif</span> <span class="n">title_in</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">title_in</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="n">title_in</span><span class="p">,)</span>

    <span class="c1"># TAGS</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;# Add comma-separated TAGS in next line (single line).&#39;</span><span class="p">,)</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tags_in</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">DELIM</span><span class="p">),)</span> <span class="k">if</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># DESC</span>
    <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;# Add COMMENTS in next line(s). Leave blank to web fetch, &quot;-&quot; for no comments.&#39;</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">desc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,)</span>
    <span class="k">elif</span> <span class="n">desc</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">strings</span> <span class="o">+=</span> <span class="p">(</span><span class="n">desc</span><span class="p">,)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_temp_file_content"><a class="viewcode-back" href="../buku.html#buku.parse_temp_file_content">[docs]</a><span class="k">def</span> <span class="nf">parse_temp_file_content</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse and return temporary file content.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    content : str</span>
<span class="sd">        String of content.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        (url, title, tags, comments)</span>

<span class="sd">        url: URL to open</span>
<span class="sd">        title: string title to add manually</span>
<span class="sd">        tags: string of comma-separated tags to add manually</span>
<span class="sd">        comments: string description</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">content</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="ow">or</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;#&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span> <span class="ow">or</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Edit aborted&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">title</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">([</span><span class="n">content</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>

    <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
        <span class="c1"># need to remove all empty line that are at the end</span>
        <span class="c1"># and not those in the middle of the text</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">comments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comments</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">comments</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">url</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">comments</span></div>


<div class="viewcode-block" id="edit_rec"><a class="viewcode-back" href="../buku.html#buku.edit_rec">[docs]</a><span class="k">def</span> <span class="nf">edit_rec</span><span class="p">(</span><span class="n">editor</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">desc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit a bookmark record.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    editor : str</span>
<span class="sd">        Editor to open.</span>
<span class="sd">    URL : str</span>
<span class="sd">        URL to open.</span>
<span class="sd">    title_in : str</span>
<span class="sd">        Title to add manually.</span>
<span class="sd">    tags_in : str</span>
<span class="sd">        Comma-separated tags to add manually.</span>
<span class="sd">    desc : str</span>
<span class="sd">        Bookmark description.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Parsed results from parse_temp_file_content().</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">temp_file_content</span> <span class="o">=</span> <span class="n">to_temp_file_content</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags_in</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span>

    <span class="n">fd</span><span class="p">,</span> <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;buku-edit-&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">temp_file_content</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;Edited content written to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">)</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">(</span><span class="n">tmpfile</span><span class="p">,)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Cannot open editor&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Cannot open tempfile&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">parsed_content</span> <span class="o">=</span> <span class="n">parse_temp_file_content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed_content</span></div>


<div class="viewcode-block" id="setup_logger"><a class="viewcode-back" href="../buku.html#buku.setup_logger">[docs]</a><span class="k">def</span> <span class="nf">setup_logger</span><span class="p">(</span><span class="n">LOGGER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setup logger with color.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    LOGGER : logger object</span>
<span class="sd">        Logger to colorize.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decorate_emit</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">levelno</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levelno</span>

            <span class="k">if</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[35m&#39;</span>
            <span class="k">elif</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[31m&#39;</span>
            <span class="k">elif</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[33m&#39;</span>
            <span class="k">elif</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[32m&#39;</span>
            <span class="k">elif</span> <span class="n">levelno</span> <span class="o">==</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[31m&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x1b</span><span class="s1">[0m&#39;</span>

            <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">[</span><span class="si">{}</span><span class="s1">]</span><span class="se">\x1b</span><span class="s1">[0m </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">levelname</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="n">sh</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">emit</span> <span class="o">=</span> <span class="n">decorate_emit</span><span class="p">(</span><span class="n">sh</span><span class="o">.</span><span class="n">emit</span><span class="p">)</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span></div>


<div class="viewcode-block" id="piped_input"><a class="viewcode-back" href="../buku.html#buku.piped_input">[docs]</a><span class="k">def</span> <span class="nf">piped_input</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">pipeargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle piped input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pipeargs : str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
        <span class="n">pipeargs</span> <span class="o">+=</span> <span class="n">argv</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;buku: waiting for input (unexpected? try --nostdin)&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
            <span class="n">pipeargs</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">()</span></div>


<div class="viewcode-block" id="setcolors"><a class="viewcode-back" href="../buku.html#buku.setcolors">[docs]</a><span class="k">def</span> <span class="nf">setcolors</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get colors from user and separate into &#39;result&#39; list for use in arg.colors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : str</span>
<span class="sd">        Color string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Colors</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Colors&#39;</span><span class="p">,</span> <span class="s1">&#39; ID_srch, ID_STR, URL_STR, DESC_STR, TAG_STR&#39;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">Colors</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">COLORMAP</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
    <span class="n">id_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">ID_srch</span>
    <span class="n">id_str_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">ID_STR</span>
    <span class="n">url_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">URL_STR</span>
    <span class="n">desc_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">DESC_STR</span>
    <span class="n">tag_col</span> <span class="o">=</span> <span class="n">colors</span><span class="o">.</span><span class="n">TAG_STR</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">id_str_col</span><span class="p">,</span> <span class="n">url_col</span><span class="p">,</span> <span class="n">desc_col</span><span class="p">,</span> <span class="n">tag_col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="unwrap"><a class="viewcode-back" href="../buku.html#buku.unwrap">[docs]</a><span class="k">def</span> <span class="nf">unwrap</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Unwrap text.&quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="c1"># Paragraph break</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># Next line is not paragraph break, add space</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
    <span class="c1"># Handle last line</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="check_stdout_encoding"><a class="viewcode-back" href="../buku.html#buku.check_stdout_encoding">[docs]</a><span class="k">def</span> <span class="nf">check_stdout_encoding</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Make sure stdout encoding is utf-8.</span>

<span class="sd">    If not, print error message and instructions, then exit with</span>
<span class="sd">    status 1.</span>

<span class="sd">    This function is a no-op on win32 because encoding on win32 is</span>
<span class="sd">    messy, and let&#39;s just hope for the best. /s</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Use codecs.lookup to resolve text encoding alias</span>
    <span class="n">encoding</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">:</span>
        <span class="n">locale_lang</span><span class="p">,</span> <span class="n">locale_encoding</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">getlocale</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">locale_lang</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">locale_lang</span> <span class="o">=</span> <span class="s1">&#39;&lt;unknown&gt;&#39;</span>
        <span class="k">if</span> <span class="n">locale_encoding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">locale_encoding</span> <span class="o">=</span> <span class="s1">&#39;&lt;unknown&gt;&#39;</span>
        <span class="n">ioencoding</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;PYTHONIOENCODING&#39;</span><span class="p">,</span> <span class="s1">&#39;not set&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">unwrap</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        stdout encoding &#39;</span><span class="si">{encoding}</span><span class="s2">&#39; detected. ddgr requires utf-8 to</span>
<span class="s2">        work properly. The wrong encoding may be due to a non-UTF-8</span>
<span class="s2">        locale or an improper PYTHONIOENCODING. (For the record, your</span>
<span class="s2">        locale language is </span><span class="si">{locale_lang}</span><span class="s2"> and locale encoding is</span>
<span class="s2">        </span><span class="si">{locale_encoding}</span><span class="s2">; your PYTHONIOENCODING is </span><span class="si">{ioencoding}</span><span class="s2">.)</span>

<span class="s2">        Please set a UTF-8 locale (e.g., en_US.UTF-8) or set</span>
<span class="s2">        PYTHONIOENCODING to utf-8.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">locale_lang</span><span class="o">=</span><span class="n">locale_lang</span><span class="p">,</span>
            <span class="n">locale_encoding</span><span class="o">=</span><span class="n">locale_encoding</span><span class="p">,</span>
            <span class="n">ioencoding</span><span class="o">=</span><span class="n">ioencoding</span><span class="p">,</span>
        <span class="p">))))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="monkeypatch_textwrap_for_cjk"><a class="viewcode-back" href="../buku.html#buku.monkeypatch_textwrap_for_cjk">[docs]</a><span class="k">def</span> <span class="nf">monkeypatch_textwrap_for_cjk</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Monkeypatch textwrap for CJK wide characters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="o">.</span><span class="n">patched</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">psl_textwrap_wrap</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span>

    <span class="k">def</span> <span class="nf">textwrap_wrap</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># We first add a U+0000 after each East Asian Fullwidth or East</span>
        <span class="c1"># Asian Wide character, then fill to width - 1 (so that if a NUL</span>
        <span class="c1"># character ends up on a new line, we still have one last column</span>
        <span class="c1"># to spare for the preceding wide character). Finally we strip</span>
        <span class="c1"># all the NUL characters.</span>
        <span class="c1">#</span>
        <span class="c1"># East Asian Width: https://www.unicode.org/reports/tr11/</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">psl_textwrap_wrap</span><span class="p">(</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">ch</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">east_asian_width</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">ch</span>
                    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFC&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">textwrap_fill</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">textwrap_wrap</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span> <span class="o">=</span> <span class="n">textwrap_wrap</span>
    <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">textwrap_fill</span>
    <span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="o">.</span><span class="n">patched</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="o">.</span><span class="n">patched</span> <span class="o">=</span> <span class="kc">True</span></div>

<span class="c1"># main starts here</span>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../buku.html#buku.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Main.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">ID_STR</span><span class="p">,</span> <span class="n">ID_DB_STR</span><span class="p">,</span> <span class="n">MUTE_STR</span><span class="p">,</span> <span class="n">URL_STR</span><span class="p">,</span> <span class="n">DESC_STR</span><span class="p">,</span> <span class="n">DESC_WRAP</span><span class="p">,</span> <span class="n">TAG_STR</span><span class="p">,</span> <span class="n">TAG_WRAP</span><span class="p">,</span> <span class="n">PROMPTMSG</span>

    <span class="n">title_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tags_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">desc_in</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pipeargs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">colorstr_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BUKU_COLORS&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;--nostdin&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">piped_input</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span> <span class="n">pipeargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># If piped input, set argument vector</span>
        <span class="k">if</span> <span class="n">pipeargs</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">pipeargs</span>

    <span class="c1"># Setup custom argument parser</span>
    <span class="n">argparser</span> <span class="o">=</span> <span class="n">ExtendedArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Bookmark manager like a text-based mini-web.</span>

<span class="s1">POSITIONAL ARGUMENTS:</span>
<span class="s1">      KEYWORD              search keywords&#39;&#39;&#39;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">,</span>
        <span class="n">usage</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;buku [OPTIONS] [KEYWORD [KEYWORD ...]]&#39;&#39;&#39;</span><span class="p">,</span>
        <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">hide</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span>

    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;KEYWORD&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>

    <span class="c1"># ---------------------</span>
    <span class="c1"># GENERAL OPTIONS GROUP</span>
    <span class="c1"># ---------------------</span>

    <span class="n">general_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;GENERAL OPTIONS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    -a, --add URL [tag, ...]</span>
<span class="s1">                         bookmark URL with comma-separated tags</span>
<span class="s1">    -u, --update [...]   update fields of an existing bookmark</span>
<span class="s1">                         accepts indices and ranges</span>
<span class="s1">                         refresh title and desc if no edit options</span>
<span class="s1">                         if no arguments:</span>
<span class="s1">                         - update results when used with search</span>
<span class="s1">                         - otherwise refresh all titles and desc</span>
<span class="s1">    -w, --write [editor|index]</span>
<span class="s1">                         edit and add a new bookmark in editor</span>
<span class="s1">                         else, edit bookmark at index in EDITOR</span>
<span class="s1">                         edit last bookmark, if index=-1</span>
<span class="s1">                         if no args, edit new bookmark in EDITOR</span>
<span class="s1">    -d, --delete [...]   remove bookmarks from DB</span>
<span class="s1">                         accepts indices or a single range</span>
<span class="s1">                         if no arguments:</span>
<span class="s1">                         - delete results when used with search</span>
<span class="s1">                         - otherwise delete all bookmarks</span>
<span class="s1">    -h, --help           show this information and exit</span>
<span class="s1">    -v, --version        show the program version and exit&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">general_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--add&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--update&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--write&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">get_system_editor</span><span class="p">(),</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--delete&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;--help&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--version&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>

    <span class="c1"># ------------------</span>
    <span class="c1"># EDIT OPTIONS GROUP</span>
    <span class="c1"># ------------------</span>

    <span class="n">edit_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;EDIT OPTIONS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    --url keyword        bookmark link</span>
<span class="s1">    --tag [+|-] [...]    comma-separated tags</span>
<span class="s1">                         clear bookmark tagset, if no arguments</span>
<span class="s1">                         &#39;+&#39; appends to, &#39;-&#39; removes from tagset</span>
<span class="s1">    --title [...]        bookmark title; if no arguments:</span>
<span class="s1">                         -a: do not set title, -u: clear title</span>
<span class="s1">    -c, --comment [...]  notes or description of the bookmark</span>
<span class="s1">                         clears description, if no arguments</span>
<span class="s1">    --immutable N        disable web-fetch during auto-refresh</span>
<span class="s1">                         N=0: mutable (default), N=1: immutable&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">edit_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--url&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--tag&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--title&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--comment&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--immutable&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># SEARCH OPTIONS GROUP</span>
    <span class="c1"># --------------------</span>

    <span class="n">search_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SEARCH OPTIONS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    -s, --sany [...]     find records with ANY matching keyword</span>
<span class="s1">                         this is the default search option</span>
<span class="s1">    -S, --sall [...]     find records matching ALL the keywords</span>
<span class="s1">                         special keywords -</span>
<span class="s1">                         &quot;blank&quot;: entries with empty title/tag</span>
<span class="s1">                         &quot;immutable&quot;: entries with locked title</span>
<span class="s1">    --deep               match substrings (&#39;pen&#39; matches &#39;opens&#39;)</span>
<span class="s1">    -r, --sreg expr      run a regex search</span>
<span class="s1">    -t, --stag [tag [,|+] ...] [- tag, ...]</span>
<span class="s1">                         search bookmarks by tags</span>
<span class="s1">                         use &#39;,&#39; to find entries matching ANY tag</span>
<span class="s1">                         use &#39;+&#39; to find entries matching ALL tags</span>
<span class="s1">                         excludes entries with tags after &#39; - &#39;</span>
<span class="s1">                         list all tags, if no search keywords</span>
<span class="s1">    -x, --exclude [...]  omit records matching specified keywords&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">search_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--sany&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-S&#39;</span><span class="p">,</span> <span class="s1">&#39;--sall&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--sreg&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--deep&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--stag&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-x&#39;</span><span class="p">,</span> <span class="s1">&#39;--exclude&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>

    <span class="c1"># ------------------------</span>
    <span class="c1"># ENCRYPTION OPTIONS GROUP</span>
    <span class="c1"># ------------------------</span>

    <span class="n">crypto_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;ENCRYPTION OPTIONS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    -l, --lock [N]       encrypt DB in N (default 8) # iterations</span>
<span class="s1">    -k, --unlock [N]     decrypt DB in N (default 8) # iterations&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">crypto_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="s1">&#39;--unlock&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--lock&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>

    <span class="c1"># ----------------</span>
    <span class="c1"># POWER TOYS GROUP</span>
    <span class="c1"># ----------------</span>

    <span class="n">power_grp</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;POWER TOYS&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;    --ai                 auto-import from Firefox/Chrome/Chromium</span>
<span class="s1">    -e, --export file    export bookmarks to Firefox format HTML</span>
<span class="s1">                         export Markdown, if file ends with &#39;.md&#39;</span>
<span class="s1">                         format: [title](url) &lt;!-- TAGS --&gt;</span>
<span class="s1">                         export Orgfile, if file ends with &#39;.org&#39;</span>
<span class="s1">                         format: *[[url][title]] :tags:</span>
<span class="s1">                         export buku DB, if file ends with &#39;.db&#39;</span>
<span class="s1">                         combines with search results, if opted</span>
<span class="s1">    -i, --import file    import bookmarks based on file extension</span>
<span class="s1">                         supports &#39;html&#39;, &#39;json&#39;, &#39;md&#39;, &#39;org&#39;, &#39;db&#39;</span>
<span class="s1">    -p, --print [...]    show record details by indices, ranges</span>
<span class="s1">                         print all bookmarks, if no arguments</span>
<span class="s1">                         -n shows the last n results (like tail)</span>
<span class="s1">    -f, --format N       limit fields in -p or JSON search output</span>
<span class="s1">                         N=1: URL; N=2: URL, tag; N=3: title;</span>
<span class="s1">                         N=4: URL, title, tag; N=5: title, tag;</span>
<span class="s1">                         N0 (10, 20, 30, 40, 50) omits DB index</span>
<span class="s1">    -j, --json [file]    JSON formatted output for -p and search.</span>
<span class="s1">                         prints to stdout if argument missing.</span>
<span class="s1">                         otherwise writes to given file</span>
<span class="s1">    --colors COLORS      set output colors in five-letter string</span>
<span class="s1">    --nc                 disable color output</span>
<span class="s1">    -n, --count N        show N results per page (default 10)</span>
<span class="s1">    --np                 do not show the subprompt, run and exit</span>
<span class="s1">    -o, --open [...]     browse bookmarks by indices and ranges</span>
<span class="s1">                         open a random bookmark, if no arguments</span>
<span class="s1">    --oa                 browse all search results immediately</span>
<span class="s1">    --replace old new    replace old tag with new tag everywhere</span>
<span class="s1">                         delete old tag, if new tag not specified</span>
<span class="s1">    --shorten index|URL  fetch shortened url from tny.im service</span>
<span class="s1">    --expand index|URL   expand a tny.im shortened url</span>
<span class="s1">    --cached index|URL   browse a cached page from Wayback Machine</span>
<span class="s1">    --suggest            show similar tags when adding bookmarks</span>
<span class="s1">    --tacit              reduce verbosity, skip some confirmations</span>
<span class="s1">    --nostdin            do not wait for input (must be first arg)</span>
<span class="s1">    --threads N          max network connections in full refresh</span>
<span class="s1">                         default N=4, min N=1, max N=10</span>
<span class="s1">    -V                   check latest upstream version available</span>
<span class="s1">    -g, --debug          show debug information and verbose logs&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">addarg</span> <span class="o">=</span> <span class="n">power_grp</span><span class="o">.</span><span class="n">add_argument</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--ai&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;--export&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--import&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;importfile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--print&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--format&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">},</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-j&#39;</span><span class="p">,</span> <span class="s1">&#39;--json&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--colors&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;colorstr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">argparser</span><span class="o">.</span><span class="n">is_colorstr</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;COLORS&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--nc&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--count&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--np&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--open&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--oa&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--replace&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--shorten&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--expand&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--cached&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--suggest&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--tacit&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--nostdin&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--threads&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-V&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;upstream&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="c1"># Undocumented APIs</span>
    <span class="c1"># Fix uppercase tags allowed in releases before v2.7</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--fixtags&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>
    <span class="c1"># App-use only, not for manual usage</span>
    <span class="n">addarg</span><span class="p">(</span><span class="s1">&#39;--db&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">hide</span><span class="p">)</span>

    <span class="c1"># Parse the arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Show help and exit if help requested</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
        <span class="n">argparser</span><span class="o">.</span><span class="n">print_help</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># By default, buku uses ANSI colors. As Windows does not really use them,</span>
    <span class="c1"># we&#39;d better check for known working console emulators first. Currently,</span>
    <span class="c1"># only ConEmu is supported. If the user does not use ConEmu, colors are</span>
    <span class="c1"># disabled unless --colors or %BUKU_COLORS% is specified.</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ConemuDir&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">colorstr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">colorstr_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Handle color output preference</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">nc</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;[</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Set colors</span>
        <span class="k">if</span> <span class="n">colorstr_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Someone set BUKU_COLORS.</span>
            <span class="n">colorstr</span> <span class="o">=</span> <span class="n">colorstr_env</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">colorstr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colorstr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">colorstr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colorstr</span> <span class="o">=</span> <span class="s1">&#39;oKlxm&#39;</span>

        <span class="n">ID</span> <span class="o">=</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">. &#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">ID_DB_dim</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">ID_STR</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ID_DB_dim</span>
        <span class="n">ID_DB_STR</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">MUTE_STR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="se">\x1b</span><span class="s1">[2m(L)</span><span class="se">\x1b</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">URL_STR</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   &gt; &#39;</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">DESC_STR</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   + &#39;</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">DESC_WRAP</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">TAG_STR</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   # &#39;</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">TAG_WRAP</span> <span class="o">=</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">setcolors</span><span class="p">(</span><span class="n">colorstr</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">COLORMAP</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

        <span class="c1"># Enable color in logs</span>
        <span class="n">setup_logger</span><span class="p">(</span><span class="n">LOGGER</span><span class="p">)</span>

        <span class="c1"># Enable prompt with reverse video</span>
        <span class="n">PROMPTMSG</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\001\x1b</span><span class="s1">[7</span><span class="se">\002</span><span class="s1">mbuku (? for help)</span><span class="se">\001\x1b</span><span class="s1">[0m</span><span class="se">\002</span><span class="s1"> &#39;</span>

    <span class="c1"># Enable browser output in case of a text based browser</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BROWSER&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">TEXT_BROWSERS</span><span class="p">:</span>
        <span class="n">browse</span><span class="o">.</span><span class="n">suppress_browser_output</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">browse</span><span class="o">.</span><span class="n">suppress_browser_output</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Overriding text browsers is disabled by default</span>
    <span class="n">browse</span><span class="o">.</span><span class="n">override_text_browser</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Fallback to prompt if no arguments</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">nostdin</span><span class="p">)):</span>
        <span class="n">bdb</span> <span class="o">=</span> <span class="n">BukuDb</span><span class="p">()</span>
        <span class="n">prompt</span><span class="p">(</span><span class="n">bdb</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Set up debugging</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;buku v</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;Python v</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">urllib3</span><span class="o">.</span><span class="n">disable_warnings</span><span class="p">()</span>

    <span class="c1"># Handle encrypt/decrypt options at top priority</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">lock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">BukuCrypt</span><span class="o">.</span><span class="n">encrypt_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">unlock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">BukuCrypt</span><span class="o">.</span><span class="n">decrypt_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">unlock</span><span class="p">)</span>

    <span class="c1"># Set up title</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">title</span><span class="p">:</span>
            <span class="n">title_in</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Set up tags</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span>
            <span class="n">tags_in</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tags_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">DELIM</span><span class="p">,</span> <span class="p">]</span>

    <span class="c1"># Set up comment</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">comment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
            <span class="n">desc_in</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desc_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="c1"># Initialize the database and get handles, set verbose by default</span>
    <span class="n">bdb</span> <span class="o">=</span> <span class="n">BukuDb</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">json</span><span class="p">,</span>
        <span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
        <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="p">,</span>
        <span class="n">dbfile</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">colorize</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">nc</span>
    <span class="p">)</span>

    <span class="c1"># Editor mode</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">write</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_editor_valid</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">):</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bdb</span><span class="o">.</span><span class="n">edit_update_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">):</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Edit and add a new bookmark</span>
            <span class="c1"># Parse tags into a comma-separated string</span>
            <span class="k">if</span> <span class="n">tags_in</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">edit_rec</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">suggest</span><span class="p">:</span>
                    <span class="n">tags</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">suggest_similar_tag</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">)</span>

    <span class="c1"># Add record</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Bookmark a single URL at a time&#39;</span><span class="p">)</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Parse tags into a comma-separated string</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="n">DELIM</span>
        <span class="n">keywords</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span>
        <span class="k">if</span> <span class="n">tags_in</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tags_in</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># The case: buku -a url tag1, tag2 --tag + tag3, tag4</span>
                    <span class="n">tags_in</span> <span class="o">=</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="c1"># In case of add, args.add may have URL followed by tags</span>
                    <span class="c1"># Add delimiter as url+tags may not end with one</span>
                    <span class="n">keywords</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span> <span class="o">+</span> <span class="p">[</span><span class="n">DELIM</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags_in</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span> <span class="o">+</span> <span class="p">[</span><span class="n">DELIM</span><span class="p">]</span> <span class="o">+</span> <span class="n">tags_in</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># args.add is URL followed by optional tags</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">add</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">edit_aborted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">write</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">edit_rec</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edit_aborted</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">edit_aborted</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">suggest</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">suggest_similar_tag</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">add_rec</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">)</span>

    <span class="c1"># Search record</span>
    <span class="n">search_results</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">search_opted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">tags_search</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">stag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">stag</span><span class="p">))</span>
    <span class="n">exclude_results</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">exclude</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">sany</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sany</span><span class="p">):</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;args.sany&#39;</span><span class="p">)</span>
            <span class="c1"># Apply tag filtering, if opted</span>
            <span class="k">if</span> <span class="n">tags_search</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">search_keywords_and_filter_by_tags</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">sany</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">stag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Search URLs, titles, tags for any keyword</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sany</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exclude_results</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">exclude_results_from_search</span><span class="p">(</span>
                    <span class="n">search_results</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">deep</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;no keyword&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sall</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sall</span><span class="p">):</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;args.sall&#39;</span><span class="p">)</span>
            <span class="c1"># Apply tag filtering, if opted</span>
            <span class="k">if</span> <span class="n">tags_search</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">search_keywords_and_filter_by_tags</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">sall</span><span class="p">,</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">stag</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Search URLs, titles, tags with all keywords</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sall</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exclude_results</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">exclude_results_from_search</span><span class="p">(</span>
                    <span class="n">search_results</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">deep</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;no keyword&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">sreg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sreg</span><span class="p">):</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;args.sreg&#39;</span><span class="p">)</span>
            <span class="c1"># Apply tag filtering, if opted</span>
            <span class="k">if</span> <span class="n">tags_search</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">search_keywords_and_filter_by_tags</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">sreg</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">,</span>
                    <span class="kc">True</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">stag</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Run a regular expression search</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sreg</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exclude_results</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">exclude_results_from_search</span><span class="p">(</span>
                    <span class="n">search_results</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">deep</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;no expression&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">):</span>
        <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;args.keywords&#39;</span><span class="p">)</span>
        <span class="c1"># Apply tag filtering, if opted</span>
        <span class="k">if</span> <span class="n">tags_search</span><span class="p">:</span>
            <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">search_keywords_and_filter_by_tags</span><span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">stag</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Search URLs, titles, tags for any keyword</span>
            <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">searchdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exclude_results</span><span class="p">:</span>
            <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">exclude_results_from_search</span><span class="p">(</span>
                <span class="n">search_results</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">deep</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">stag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">stag</span><span class="p">):</span>
            <span class="n">LOGDBG</span><span class="p">(</span><span class="s1">&#39;args.stag&#39;</span><span class="p">)</span>
            <span class="c1"># Search bookmarks by tag</span>
            <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">search_by_tag</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">stag</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">exclude_results</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">exclude_results_from_search</span><span class="p">(</span>
                    <span class="n">search_results</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">deep</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use sub prompt to list all tags</span>
            <span class="n">prompt</span><span class="p">(</span><span class="n">bdb</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">,</span> <span class="n">listtags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suggest</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">suggest</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;No search criteria to exclude results from&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">search_opted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Add cmdline search options to readline history</span>
    <span class="k">if</span> <span class="n">search_opted</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">readline</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">check_stdout_encoding</span><span class="p">()</span>
    <span class="n">monkeypatch_textwrap_for_cjk</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">search_results</span><span class="p">:</span>
        <span class="n">oneshot</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">np</span>
        <span class="n">update_search_results</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Open all results in browser right away if args.oa</span>
        <span class="c1"># is specified. The has priority over delete/update.</span>
        <span class="c1"># URLs are opened first and updated/deleted later.</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">oa</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">search_results</span><span class="p">:</span>
                <span class="n">browse</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">export</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">)):</span>
            <span class="n">oneshot</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">json</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">count</span> <span class="k">else</span> <span class="n">args</span><span class="o">.</span><span class="n">count</span>
            <span class="n">prompt</span><span class="p">(</span><span class="n">bdb</span><span class="p">,</span> <span class="n">search_results</span><span class="p">,</span> <span class="n">oneshot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">deep</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">print_rec_with_filter</span><span class="p">(</span><span class="n">search_results</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">write_string_to_file</span><span class="p">(</span><span class="n">format_json</span><span class="p">(</span><span class="n">search_results</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">),</span> <span class="n">args</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Printing in JSON format is non-interactive</span>
            <span class="n">print_json_safe</span><span class="p">(</span><span class="n">search_results</span><span class="p">,</span> <span class="n">field_filter</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>

        <span class="c1"># Export the results, if opted</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">export</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">exportdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">export</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">search_results</span><span class="p">)</span>

        <span class="c1"># In case of search and delete/update,</span>
        <span class="c1"># prompt should be non-interactive</span>
        <span class="c1"># delete gets priority over update</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">delete_resultset</span><span class="p">(</span><span class="n">search_results</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
            <span class="n">update_search_results</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Update record</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url_in</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">url</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Parse tags into a comma-separated string</span>
        <span class="k">if</span> <span class="n">tags_in</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="n">tags_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">parse_tags</span><span class="p">(</span><span class="n">tags_in</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># No arguments to --update, update all</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
            <span class="c1"># Update all records only if search was not opted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">search_opted</span><span class="p">:</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">url_in</span><span class="p">,</span> <span class="n">title_in</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">desc_in</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">update_search_results</span> <span class="ow">and</span> <span class="n">search_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updated results:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_results</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">search_results</span><span class="p">[</span><span class="n">pos</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span>
                        <span class="n">idx</span><span class="p">,</span>
                        <span class="n">url_in</span><span class="p">,</span>
                        <span class="n">title_in</span><span class="p">,</span>
                        <span class="n">tags</span><span class="p">,</span>
                        <span class="n">desc_in</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">threads</span>
                    <span class="p">)</span>

                    <span class="c1"># Commit at every 200th removal</span>
                    <span class="k">if</span> <span class="n">pos</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                    <span class="n">pos</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                        <span class="n">url_in</span><span class="p">,</span>
                        <span class="n">title_in</span><span class="p">,</span>
                        <span class="n">tags</span><span class="p">,</span>
                        <span class="n">desc_in</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">threads</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># Update only once if range starts from 0 (all)</span>
                        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span>
                                <span class="mi">0</span><span class="p">,</span>
                                <span class="n">url_in</span><span class="p">,</span>
                                <span class="n">title_in</span><span class="p">,</span>
                                <span class="n">tags</span><span class="p">,</span>
                                <span class="n">desc_in</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span>
                                <span class="n">args</span><span class="o">.</span><span class="n">threads</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                <span class="n">bdb</span><span class="o">.</span><span class="n">update_rec</span><span class="p">(</span>
                                    <span class="n">_id</span><span class="p">,</span>
                                    <span class="n">url_in</span><span class="p">,</span>
                                    <span class="n">title_in</span><span class="p">,</span>
                                    <span class="n">tags</span><span class="p">,</span>
                                    <span class="n">desc_in</span><span class="p">,</span>
                                    <span class="n">args</span><span class="o">.</span><span class="n">immutable</span><span class="p">,</span>
                                    <span class="n">args</span><span class="o">.</span><span class="n">threads</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">INTERRUPTED</span><span class="p">:</span>
                                    <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Invalid index or range to update&#39;</span><span class="p">)</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">INTERRUPTED</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="c1"># Delete record</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
            <span class="c1"># Attempt delete-all only if search was not opted</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">search_opted</span><span class="p">:</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">cleardb</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">delete_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Invalid index or range to delete&#39;</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Select the unique indices</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">delete</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">ids</span> <span class="o">+=</span> <span class="p">(</span><span class="n">idx</span><span class="p">,)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Index delete order - highest to lowest</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">delete_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Invalid index or range or combination&#39;</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Print record</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">print</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">list_using_id</span><span class="p">()</span>
                <span class="n">prompt</span><span class="p">(</span><span class="n">bdb</span><span class="p">,</span> <span class="n">search_results</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">count</span><span class="p">:</span>
                <span class="n">search_results</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">list_using_id</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">print</span><span class="p">)</span>
                <span class="n">prompt</span><span class="p">(</span><span class="n">bdb</span><span class="p">,</span> <span class="n">search_results</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">np</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">print</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                            <span class="n">bdb</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                            <span class="n">bdb</span><span class="o">.</span><span class="n">print_rec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Invalid index or range to print&#39;</span><span class="p">)</span>
                    <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Replace a tag in DB</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">delete_tag_at_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">replace_tag</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># Export bookmarks</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">export</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">search_opted</span><span class="p">:</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">exportdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">export</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Import bookmarks</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">importfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">importdb</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">importfile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="p">)</span>

    <span class="c1"># Import bookmarks from browser</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ai</span><span class="p">:</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">auto_import_from_browser</span><span class="p">()</span>

    <span class="c1"># Open URL in browser</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">open</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">open</span><span class="p">:</span>
            <span class="n">bdb</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">open</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
                        <span class="n">bdb</span><span class="o">.</span><span class="n">browse_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">LOGERR</span><span class="p">(</span><span class="s1">&#39;Invalid index or range to open&#39;</span><span class="p">)</span>
                <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Shorten URL</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">shorten</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">shorten</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">shorturl</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">tnyfy_url</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">shorten</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shorturl</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">tnyfy_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">shorten</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">shorturl</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">shorturl</span><span class="p">)</span>

    <span class="c1"># Expand URL</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">expand</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">expand</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">tnyfy_url</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">expand</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shorten</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">tnyfy_url</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">expand</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shorten</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Try to fetch URL from Wayback Machine</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">cached</span><span class="p">:</span>
        <span class="n">wbu</span> <span class="o">=</span> <span class="n">bdb</span><span class="o">.</span><span class="n">browse_cached_url</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cached</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">wbu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">browse</span><span class="p">(</span><span class="n">wbu</span><span class="p">)</span>

    <span class="c1"># Report upstream version</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">upstream</span><span class="p">:</span>
        <span class="n">check_upstream_release</span><span class="p">()</span>

    <span class="c1"># Fix tags</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fixtags</span><span class="p">:</span>
        <span class="n">bdb</span><span class="o">.</span><span class="n">fixtags</span><span class="p">()</span>

    <span class="c1"># Close DB connection and quit</span>
    <span class="n">bdb</span><span class="o">.</span><span class="n">close_quit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Arun Prakash Jana.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>